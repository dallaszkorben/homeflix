<meta charset="UTF-8" comntent="text/html;charset=utf-8" http-equiv="Content-Type">

<!DOCTYPE html>
<html>

<head>

    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/js-jaml/js-yaml.js"></script>

    <link href="script/fancybox/jquery.fancybox.min.css" rel="stylesheet" />
    <script src="script/fancybox/jquery.fancybox.min.js"></script>

<!--    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css"> -->
    <link rel="stylesheet" href="script/jquery-ui/jquery-ui.css">
    <script src="script/jquery-ui/jquery-ui.js"></script>

    <link rel="stylesheet" href="script/highlight/styles/atom-one-dark.min.css">
    <script src="script/highlight/highlight.min.js"></script>

    <script src="container.js"></script>
    <script src="generators.js"></script>

    <link rel="stylesheet" href="stylesheet.css">
    <link rel="icon" href="favicon.ico">

    <script>

        let PREFIX_LOCAL_STORAGE = "homeflix"

        //let host = "192.168.0.21"
        //let host = "localhost"
        let host = location.hostname;
        let port = ":80";

        let language_dict = {"hu": "Magyar", "en": "English"};

        //
        // Try to restore the previous session calling the login without credentials
        //
        let rq_method = "POST";
        let rq_url = "http://" + host + port + "/auth/login";
        let rq_data = {"username": null, "password": null};
        let rq_assync = false;
        let result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, data: rq_data, dataType: "json" });
        let user_data = result.responseJSON['data'];

        if(!result.responseJSON['result'] || Object.keys(user_data).length === 0){
            user_data = {
                language_code: "en",
                name: null,
                is_admin: true,
                descriptor_color: 'rgb(129, 60, 41)',
                always_show_original_title: true,
                show_lyrics_anyway: true,
                show_storyline_anyway: true,
                play_continuously: true
            }
        }

        let version;
        let translated_titles;
        let translated_genre_movie;
        let translated_categories;
        let translated_themes;

        // Load Version
        rq_method = "GET";
        rq_url = "http://" + host + port + "/info/version";
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        result = result.responseJSON;
        version = result['version'];

        // Load Translated Titles
        rq_method = "GET";
        rq_url = "http://" + host + port + "/translate/titles/lang/" + user_data['language_code'];
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        translated_titles = result.responseJSON;

        // Load Translated Interaction Labels
        rq_method = "GET";
        rq_url = "http://" + host + port + "/translate/interaction_labels/lang/" + user_data['language_code'];
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        translated_interaction_labels = result.responseJSON;

        // Load Translated Genre: Movie
        rq_method = "GET";
        rq_url = "http://" + host + port + "/translate/genres/category/movie/lang/" + user_data['language_code'];
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        translated_genre_movie = result.responseJSON;

        // Load Translated Themes
        rq_method = "GET";
        rq_url = "http://" + host + port + "/translate/themes/lang/" + user_data['language_code'];
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        translated_themes = result.responseJSON;

        // Load Translated Categories
        rq_method = "GET";
        rq_url = "http://" + host + port + "/translate/categories/lang/" + user_data['language_code'];
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        translated_categories = result.responseJSON;

        // Load Translated Genre: Music
        rq_method = "GET";
        rq_url = "http://" + host + port + "/translate/genres/category/music/lang/" + user_data['language_code'];
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        translated_genre_music = result.responseJSON;

        // Load Translated Levels
        rq_method = "GET";
        rq_url = "http://" + host + port + "/translate/levels/lang/" + user_data['language_code'];
        rq_assync = false;
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        translated_levels = result.responseJSON;

        /*
        Substitute substrings, similar to "Hello {0}".format("world") mechanizm
        Usage: "hello {123}".format("123", world")
        */
        String.prototype.format = function () {
            var i = 0, args = arguments;
            return this.replace("{" + args[0] + "}", function () {
                return typeof args[1] != 'undefined' ? args[1] : '';
            });
        };

        /*
        Generate HASH code
        */
        String.prototype.hashCode = function() {
            var hash = 0, i, chr;
            if (this.length === 0) return hash;
            for (i = 0; i < this.length; i++) {
                chr = this.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0; // Convert to 32bit integer
            }
            return hash;
        }

        // String.prototype.format = function () {
        //     var i = 0, args = arguments;
        //     return this.replace(/{}/g, function () {
        //         console.log("args[0]: "+ args[0]);
        //         console.log("args[1]: "+ args[1]);
        //         return typeof args[i] != 'undefined' ? args[i++] : '';
        //     });
        // };

        // Delay in any async function: await delay(100);
        const delay = ms => new Promise(res => setTimeout(res, ms));

        function print(value){
            let stringValue = typeof value === 'object' ? JSON.stringify(value) : String(value);
            console.log(stringValue);
        }


        function pathJoin(parts, sep) {
            var separator = sep || '/';
            var replace = new RegExp(separator + '{1,}', 'g');
            return parts.join(separator).replace(replace, separator);
        }


        /**
         * LocalStorage
         */
        function getLocalStorage(key, defaultValue){

            let value = localStorage.getItem(key);
            return value;
        }

        function setLocalStorage(key, value){
            localStorage.setItem(key,value);
        }

        function deleteLocalStorage(key) {
            localStorage.removeItem(key);
        }

        function deleteLocalStorageStartingWith(prefix) {
            const keysToDelete = [];

            // First collect all matching keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    keysToDelete.push(key);
                }
            }

            // Then remove them
            keysToDelete.forEach(key => {
                localStorage.removeItem(key);
            });
        }

        /**
         *  Cookies
         */
        function getExistingCookie(key){
            let name = key + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return value = c.substring(name.length, c.length);
                }
            }

            return null;
        }

        function getCookie(key, defaultValue){

            let value = getExistingCookie(key);
            if( value == null ){
                value = defaultValue;
                document.cookie = name + "=" + value;
            }
            return value;
        }

        function setCookie(key, value){
            document.cookie = key + "=" + value;
        }

        function formatSecondsToTimeCode(seconds) {
            // Calculate hours, minutes, and seconds
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            // Format hours, minutes, and seconds into the desired string
            const formattedTime = `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

            return formattedTime;
        }

        function formatTimeCodeToSeconds(timeCode){
            const [hours, minutes, seconds] = timeCode.split(':').map(Number);

            // Convert to seconds
            const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;

            return totalSeconds;
        }

        //
        // Calculate the containers sizes
        //

        // var desc_img_height;
        // var desc_img_width;

        // Thumbnail
        const thumbnail_border_width = 7;
        const thumbnail_border_color = 'rgb(200, 0, 0)';
        const thumbnail_image_width = 160;
        const thumbnail_image_height = 208;
        const thumbnail_background = 'rgb(100, 100, 100)';

        const thumbnail_text_font_size = 30;
        const thumbnail_text_font_color = 'rgb(7, 24, 101)'
        const thumbnail_text_font_shadow_color = 'rgb(255,255,255)'

        // Container
        const thumbnail_container_border_width = 4
        const thumbnail_container_border_color = 'rgb(100, 100, 100)';
        const thumbnail_container_background = 'rgb(100, 100, 100)';
        const thumbnail_container_height = thumbnail_image_height + (2 * thumbnail_border_width) + (2 * thumbnail_container_border_width)

        // Container block
        const thumbnail_container_block_border_width = 1;
        const thumbnail_container_block_border_color = 'rgb(0, 0, 0)';
        const thumbnail_container_block_background = 'rgb(40, 40, 40)';

        // Scroll section
        const scroll_section_border_width = 0;  // Needed to be changed with description_section_border_width. If they are different, then a horizontal slider bar appears in the browser
        const scroll_section_border_color = 'rgb(30, 30, 30)';
        const scroll_section_background = 'rgb(30, 30, 30)';
        const scroll_section_height_portion = 50;

        // Static section
        const static_section_height_portion = 50;

        // History section
        const history_section_background = 'rgb(80, 80, 80)';
        const history_section_border_width = 1
        const history_section_border_color = 'rgb(0, 0, 0)';
        const history_section_font_size = 20;
        const history_section_font_color = 'rgb(0, 0, 0)';
        const history_section_height = 40;

        // Description section
        const description_section_border_width = 0; // Needed to be changed with scroll_section_border_width. If they are different, then a horizontal slider bar appears in the browser
        const description_section_border_color = 'rgb(9, 60, 41)';
        const description_section_background = 'rgb(171, 253, 176)';

        const description_text_extra_font_size = 1.6;
        const description_text_storyline_font_size = 1.3;
        const description_text_credentials_font_size = 1.3;

        const description_text_storyline_width = 45;

        const description_text_wrapper_top = scroll_section_border_width;
        const description_text_wrapper_left = scroll_section_border_width;

        t = document.querySelector(':root');

        // Thumbnail
        t.style.setProperty('--thumbnail-border-width', thumbnail_border_width + 'px');
        t.style.setProperty('--thumbnail-border-color', thumbnail_border_color);
        t.style.setProperty('--thumbnail-image-height', thumbnail_image_height + 'px');
        t.style.setProperty('--thumbnail-image-width', thumbnail_image_width + 'px');
        t.style.setProperty('--thumbnail_background', thumbnail_background);

        t.style.setProperty('--thumbnail-text-font-size', thumbnail_text_font_size + 'px');
        t.style.setProperty('--thumbnail-text-font-color', thumbnail_text_font_color);
        t.style.setProperty('--thumbnail-text-font-shadow-color', thumbnail_text_font_shadow_color);

        // Container
        t.style.setProperty('--thumbnail-container-border-width', thumbnail_container_border_width + 'px');
        t.style.setProperty('--thumbnail-container-border-color', thumbnail_container_border_color);
        t.style.setProperty('--thumbnail-container-background', thumbnail_container_background);
        t.style.setProperty('--thumbnail-container-height', thumbnail_container_height + 'px');

        // Container block
        t.style.setProperty('--thumbnail-container-block-border-color', thumbnail_container_block_border_color);
        t.style.setProperty('--thumbnail-container-block-background', thumbnail_container_block_background);
        t.style.setProperty('--thumbnail-container-block-border-width', thumbnail_container_block_border_width + 'px');

        // Scroll section
        t.style.setProperty('--scroll-section-border-width', scroll_section_border_width + 'px');
        t.style.setProperty('--scroll-section-border-color', scroll_section_border_color);
        t.style.setProperty('--scroll-section-background', scroll_section_background);
        t.style.setProperty('--scroll-section-height-portion', scroll_section_height_portion + '%');

        // Static section
        t.style.setProperty('--static-section-height-portion', static_section_height_portion + '%');

        // History section
        t.style.setProperty('--history-section-background', history_section_background);
        t.style.setProperty('--history-section-border-width', history_section_border_width + 'px');
        t.style.setProperty('--history-section-border-color', history_section_border_color);
        t.style.setProperty('--history-section-font-size', history_section_font_size + 'px');
        t.style.setProperty('--history-section-font-color', history_section_font_color);
        t.style.setProperty('--history-section-height', history_section_height + 'px');

        // Description section
        t.style.setProperty('--description-section-border-width', description_section_border_width + 'px');
        t.style.setProperty('--description-section-border-color', description_section_border_color);
        t.style.setProperty('--description-section-background', description_section_background);

        t.style.setProperty('--description-text-wrapper-top', description_text_wrapper_top + 'px');
        t.style.setProperty('--description-text-wrapper-left', description_text_wrapper_left + 'px');
        t.style.setProperty('--description-text-extra-font-size', description_text_extra_font_size + 'em');
        t.style.setProperty('--description-text-storyline-font-size', description_text_storyline_font_size + 'em');
        t.style.setProperty('--description-text-credentials-font-size', description_text_credentials_font_size + 'em');

        t.style.setProperty('--description-text-storyline-width', description_text_storyline_width + '%');

        function generateRandom(min = 0, max = 100) {

            // find diff
            let difference = max - min;

            // generate random number
            let rand = Math.random();

            // multiply with difference
            rand = Math.floor(rand * difference);

            // add with min value
            rand = rand + min;

            return rand;
        }

        function get_translated_level(level){
            if (translated_levels.hasOwnProperty(level)) {
                return translated_levels[level];
            } else {
                return level;
            }
        }


// TODO with the other translated_???? dictionaries

        $(document).ready(function () {

            //
            // if not logged in -> different descriptor color
            //
            t.style.setProperty('--description-section-left-background', user_data['descriptor_color']);

//--

//            let menu = new MainMenuGenerator(user_data['language_code']);
//            let fullMenuJson = {"definitions":{"categories":{"movies":{"genre_filter":{"descriptions":{"description_drama_with_restrictioins":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"drama"},"data":{"category":"movie","genres":"drama_AND__NOT_comedy_AND__NOT_war_AND__NOT_satire_AND__NOT_crime_AND__NOT_thriller_AND__NOT_fantasy_AND__NOT_music_AND__NOT_scifi_AND__NOT_horror"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_scifi_with_restrictioins":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"scifi"},"data":{"category":"movie","genres":"scifi_AND__NOT_trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_fantasy":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"fantasy"},"data":{"category":"movie","genres":"fantasy"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_comedy_with_restriction":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"comedy"},"data":{"category":"movie","genres":"comedy_AND__NOT_teen"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_teen":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"teen"},"data":{"category":"movie","genres":"teen"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_satire":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"satire"},"data":{"category":"movie","genres":"satire"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_crime_with_restriction":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"crime"},"data":{"category":"movie","genres":"crime_AND__NOT_trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_action_with_restriction":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"action"},"data":{"category":"movie","genres":"action_AND__NOT_trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_thriller":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"thriller"},"data":{"category":"movie","genres":"thriller"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_horror":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"horror"},"data":{"category":"movie","genres":"horror"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_western":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"western"},"data":{"category":"movie","genres":"western"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_war":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"war"},"data":{"category":"movie","genres":"war"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_music":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"music"},"data":{"category":"movie","genres":"music"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_history":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"history"},"data":{"category":"movie","genres":"history"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_documentary":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"documentary"},"data":{"category":"movie","genres":"documentary"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},"description_trash":{"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"trash"},"data":{"category":"movie","genres":"trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}}}}}}},"default":{"extends":"Generator","is_thumbnail_show_synchronous":true,"name":"main_menu","container_list":[{"order":0,"static_hard_coded":{"container_title_key":"categories","thumbnails":[{"order":0,"thumbnail":{"image":"images/categories/movie.jpg","title_key":"movies"},"description":{"image":"images/categories/movie.jpg","title_key":"movies"},"history":{"title_key":"movies"},"execution":{"extends":"GeneralRestGenerator","is_thumbnail_show_synchronous":true,"name":"movie","container_list":[{"order":0,"static_hard_coded":{"container_title_key":"movies","thumbnails":[{"order":0,"thumbnail":{"image":"images/categories/movie_mixed.jpg","title_key":"movie_mixed"},"description":{"image":"images/categories/movie_mixed.jpg","title_key":"movie_mixed"},"history":{"title_key":"movie_mixed"},"execution":{"extends":"GeneralRestGenerator","is_thumbnail_show_synchronous":true,"name":"movie_filter","container_list":[{"order":0,"static_hard_coded":{"container_title_key":"movie_filter","thumbnails":[{"order":0,"thumbnail":{"image":"images/categories/movie_by_genre.jpg","title_key":"movie_by_genre"},"description":{"image":"images/categories/movie_by_genre.jpg","title_key":"movie_by_genre"},"history":{"title_key":"movie_by_genre"},"execution":{"extends":"GeneralRestGenerator","is_thumbnail_show_synchronous":false,"name":"movie_genre","container_list":[{"order":0,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"drama"},"data":{"category":"movie","genres":"drama_AND__NOT_comedy_AND__NOT_war_AND__NOT_satire_AND__NOT_crime_AND__NOT_thriller_AND__NOT_fantasy_AND__NOT_music_AND__NOT_scifi_AND__NOT_horror"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":1,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"scifi"},"data":{"category":"movie","genres":"scifi_AND__NOT_trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":2,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"fantasy"},"data":{"category":"movie","genres":"fantasy"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":3,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"comedy"},"data":{"category":"movie","genres":"comedy_AND__NOT_teen"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":4,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"teen"},"data":{"category":"movie","genres":"teen"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":5,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"satire"},"data":{"category":"movie","genres":"satire"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":6,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"crime"},"data":{"category":"movie","genres":"crime_AND__NOT_trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":7,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"action"},"data":{"category":"movie","genres":"action_AND__NOT_trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":8,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"thriller"},"data":{"category":"movie","genres":"thriller"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":9,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"horror"},"data":{"category":"movie","genres":"horror"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":10,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"western"},"data":{"category":"movie","genres":"western"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":11,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"war"},"data":{"category":"movie","genres":"war"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":12,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"music"},"data":{"category":"movie","genres":"music"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":13,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"history"},"data":{"category":"movie","genres":"history"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":14,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"documentary"},"data":{"category":"movie","genres":"documentary"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}},{"order":15,"dynamic_hard_coded":{"title":{"dict_translator":"translated_genre_movie","id":"trash"},"data":{"category":"movie","genres":"trash"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/highest/mixed"}}}]}},{"order":2,"thumbnail":{"image":"images/categories/movie_by_director.jpg","title_key":"movie_by_director"},"description":{"image":"images/categories/movie_by_director.jpg","title_key":"movie_by_director"},"history":{"title_key":"movie_by_director"},"execution":{"extends":"GeneralRestGenerator","is_thumbnail_show_synchronous":false,"name":"movie_genre","container_list":[{"order":0,"dynamic_queried":{"pre_query":{"data":{"category":"movie","minimum":2,"limit":40},"request":{"static":"-not_needed-","method":"GET","protocol":"http","path":"/collect/directors/by/movie/count"}},"query_loop":{"data":{"category":"movie"},"data_from_pre_response_list":{"type":"value","value":"directors"},"request":{"static":false,"method":"GET","protocol":"http","path":"/collect/highest/mixed"},"title":{"dict_translator":null,"id":"name"}}}}]}}]}}]}},{"order":4,"thumbnail":{"image":"images/categories/movie_playlists.jpg","title_key":"movie_playlists"},"description":{"image":"images/categories/movie_playlists.jpg","title_key":"movie_playlists"},"history":{"title_key":"movie_playlists"},"execution":{"extends":"GeneralRestGenerator","is_thumbnail_show_synchronous":false,"name":"movie_playlist","container_list":[{"order":0,"dynamic_hard_coded":{"title":{"dict_translator":"translated_titles","id":"movie_interrupted"},"data":{"category":"movie","playlist":"interrupted"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/lowest"}}},{"order":1,"dynamic_hard_coded":{"title":{"dict_translator":"translated_titles","id":"movie_last_watched"},"data":{"category":"movie","playlist":"last_watched"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/lowest"}}},{"order":2,"dynamic_hard_coded":{"title":{"dict_translator":"translated_titles","id":"movie_most_watched"},"data":{"category":"movie","playlist":"most_watched"},"request":{"static":true,"method":"GET","protocol":"http","path":"/collect/lowest"}}},{"order":3,"dynamic_queried":{"pre_query":{"data":{"category":"movie"},"request":{"static":"-not_needed-","method":"GET","protocol":"http","path":"/personal/tag/get"}},"query_loop":{"data":{"category":"movie"},"data_from_pre_response_list":{"type":"dict","dict":{"tags":"name"}},"request":{"static":false,"method":"GET","protocol":"http","path":"/collect/lowest"},"title":{"dict_translator":null,"id":"name"}}}}]}}]}}]}}]}}]}}
//            let mainMenuDict = fullMenuJson.default;


            // Load Card Menu
            rq_method = "GET";
            rq_url = "http://" + host + port + "/personal/card_menu/get";
            rq_assync = false;
            response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
            let mainMenuDict;
            if(response.status == 200 && response.responseJSON["result"]){
                mainMenuDict = response.responseJSON["data"];
            //Card Menu Error - can not continue without menu
            }else{
                console.error(response.responseJSON["error"])
                return;
            }

            let menu = new GeneralRestGenerator(mainMenuDict, user_data['language_code'], "");

            // this triggers the produceContainers()
            let oThumbnailController = new ThumbnailController(menu);
            let oScrollSection = oThumbnailController.getScrollSection();

//--

            // -----------------------
            // Listener configurations
            // -----------------------

            //
            // Description section resize observer
            //

            // Triggered if the size of the description section changed - I have to resize the Description Image
            const resizeObserver = new ResizeObserver(entries => {

                // I do the refresh through the ThumbnailController
                oThumbnailController.resizeDescriptionSection();
            });
            const domDescSectSection = document.querySelector("#description-section");
            resizeObserver.observe(domDescSectSection);

            // Mouse enters an image
            $('.description-rating-rate img').hover(function() {
                const currentImg = $(this);
                if (currentImg.attr('src') === 'images/rating/NotSelected-x.png') {
                    currentImg.attr('src', 'images/rating/NotSelected-x-focus.png');
                } else if (currentImg.is(selectedImg)) {
                    currentImg.attr('src', currentImg.data('focus')); // Hovering over selected image
                }
            }, function() {
                const currentImg = $(this);
                if (currentImg.attr('src') === 'images/rating/NotSelected-x-focus.png') {
                    currentImg.attr('src', 'images/rating/NotSelected-x.png');
                } else if (currentImg.is(selectedImg)) {
                    currentImg.attr('src', currentImg.data('selected')); // Leaving selected image
                }
            });

            // Image clicked
            $('.description-rating-rate img').click(function() {
                if (selectedImg) {
                    // Reset the previous selected image back to not selected
                    selectedImg.attr('src', 'images/rating/NotSelected-x.png');
                }

                // Set the new selected image
                selectedImg = $(this);
                selectedImg.attr('src', selectedImg.data('selected'));
            });

            //
            // Arrow keyboard event listener
            //

            $(document).on('keydown', function (e) {
                function clickOnThumbnail() {
                    oThumbnailController.enter(e);
                }
                function clickOnEscape() {
                    oThumbnailController.escape();
                }
                function arrowLeft() {
                    oThumbnailController.arrowLeft();
                }
                function arrowUp() {
                    oThumbnailController.arrowUp();
                }
                function arrowRight() {
                    oThumbnailController.arrowRight();
                }
                function arrowDown() {
                    oThumbnailController.arrowDown();
                }
                function tab() {
                    oThumbnailController.tab();
                }

                var act = { 27: clickOnEscape, 13: clickOnThumbnail, 32: clickOnThumbnail, 37: arrowLeft, 38: arrowUp, 39: arrowRight, 40: arrowDown, 9: tab };
                if (act[e.keyCode])
                    var a = new act[e.keyCode];
            });

            let touchXPos;
            let touchYPos;

            // store the touching position at the start of each touch
            $(document).on('touchstart', function (e) {
                touchXPos = e.changedTouches[0].clientX;
                touchYPos = e.changedTouches[0].clientY;
            });

            $(document).on('touchmove', function (e) {
                let newTouchYPos = e.changedTouches[0].clientY;
                let newTouchXPos = e.changedTouches[0].clientX;

                let minDiffX = 100;
                let minDiffY = 100;
                let diffX = Math.abs(newTouchXPos - touchXPos);
                let diffY = Math.abs(newTouchYPos - touchYPos);

                if (diffX > minDiffX) {
                    if (newTouchXPos > touchXPos) {
                        oThumbnailController.arrowRight();
                    } else
                        if (newTouchXPos < touchXPos) {
                            oThumbnailController.arrowLeft();
                        }
                    touchXPos = newTouchXPos;

                } else if (diffY > minDiffY) {
                    if (newTouchYPos > touchYPos) {
                        oThumbnailController.arrowDown();
                    } else
                        if (newTouchYPos < touchYPos) {
                            oThumbnailController.arrowUp();
                        }
                    touchYPos = newTouchYPos;
                }
            });

            /********
             *      *
             * MENU *
             *      *
             ********/

            let openDropdown = false;

            // If the mouse is close to the top, the menu appears
            $(document).on('mousemove', function(event) {
                var mouseY = event.clientY;
                if (mouseY <= 60) {
                    $('#menu-line').addClass('show');
                } else if(!openDropdown){
                    $('#menu-line').removeClass('show');
                }
            });
            // To show the menu
            // $('#menu-line').addClass('show');

            // If the mouse is over the language menu, the dropdown appears
            // If the mouse is over the setting menu, the dropdown appears
            $('.main-menu').hover(function() {
                $(this).find('.dropdown').slideToggle(200);
            });

            // If I hover on the dropdown menu, the mouse can lower than 30 pxs
            $('.main-menu').hover(
                function() {
                    openDropdown = true;
                },
                function(){
                    openDropdown = false;
                }
            );


            //
            // LANGUAGE
            //
            // Set the default language in the menu
            let language_prefix = translated_interaction_labels['menu']['language']['language_prefix'];
            selectedLanguage = language_dict[user_data['language_code']];
            $('#language-menu .main-menu-text' ).text(language_prefix + ": " + selectedLanguage);

            // Select on language from the dropdown list
            $('.option.language').on('click', function() {
                let selectedLanguage = $(this).text();
                $('#language-menu .main-menu-text' ).text(language_prefix + ": " + selectedLanguage);
                // $('#language-dropdown').slideUp(200); // To bring back the menu


                // Update the language in the DB
                let rq_method = "POST";
                let rq_url = "http://" + host + port + "/personal/user_data/update";
                let rq_assync = false;
                let data = {"language_code": $(this).attr("value")}
                let response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json", data: data })

                // Restart the browser
                window.location.reload();
            });

            //
            // Server Setting
            //
            let server_setting_menu = translated_interaction_labels['menu']['server']['menu'];
            let rebuild_static_db_menu = translated_interaction_labels['menu']['server']['sub_menus']['rebuild_static_db'];
            let rebuild_personal_db_menu = translated_interaction_labels['menu']['server']['sub_menus']['rebuild_personal_db'];
            let update_software_menu = translated_interaction_labels['menu']['server']['sub_menus']['update_software'];

            $("#setting-menu .main-menu-text").text(server_setting_menu);
            $("#setting-menu li[value='rebuild-static-db']").text(rebuild_static_db_menu);
            $("#setting-menu li[value='rebuild-personal-db']").text(rebuild_personal_db_menu);
            $("#setting-menu li[value='update-sw']").text(update_software_menu);

            $('.option.setting').on('click', function() {
                let setting = $(this).attr("value");

                if(setting=="rebuild-static-db"){

                    Generator.startSpinner();

                     // Delete all request/response in the Local Storage
                     deleteLocalStorageStartingWith(PREFIX_LOCAL_STORAGE);

                    setTimeout(function(){
                        rq_method = "POST";
                        rq_url = "http://" + host + port + "/control/rebuild/db/static";
                        rq_assync = false;
                        response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
                        rebuild_result = response.responseJSON;

                        window.location.reload(true);
                    }, 100);

                }else if(setting=="rebuild-personal-db"){

                    Generator.startSpinner();

                    setTimeout(function(){
                        rq_method = "POST";
                        rq_url = "http://" + host + port + "/control/rebuild/db/personal";
                        rq_assync = false;
                        response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
                        rebuild_result = response.responseJSON;

                        window.location.reload(true);
                    }, 100);

                }else if(setting=="update-sw"){

                    Generator.startSpinner();

                    // Delete all request/response in the Local Storage
                    deleteLocalStorageStartingWith(PREFIX_LOCAL_STORAGE);

                    setTimeout(function(){
                        rq_method = "POST";
                        rq_url = "http://" + host + port + "/control/update/sw";
                        rq_assync = false;
                        response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
                        response_dict = response.responseJSON;

                        response_update = response_dict["update"]
                        response_reload = response_dict["reload"]

                        console.log("Update response: " + response_update);
                        console.log("Reload response: " + response_reload);

                        Generator.stopSpinner();

                        if(response.status != 200){
                            $("#dialog-warning-update-failed p").html("Something went wrong.<br>" + response.statusText + "<br>");
                            $("#dialog-warning-update-failed" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });

                        // The update failed - there was NO restart
                        }else if(response_update['result'] != "SUCCESS"){

                            $("#dialog-warning-update-failed p").html("Update failed.<br>" + response_update['message'] + "<br><br>Command: " + response_update['command'][0]);
                            $("#dialog-warning-update-failed" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });

                        // The reload failed - update was successful
                        }else if(response_reload['result'] != "SUCCESS"){

                            $("#dialog-warning-update-failed p").html("Software update was successful, but the server reload failed.<br>" + response_reload['message'] + "<br><br>Command: " + response_reload['command'] + "<br><br>The easiest way to reload the server is to turn OFF/ON the machine.");
                            $("#dialog-warning-update-failed" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });

                        }else{

                            $("#dialog-success-update-success p").html("Software update was successful");
                            $("#dialog-success-update-success" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });
                        }
                    }, 100);
                }
            });

            //
            // LOGIN
            //
            let login_sub_menu = translated_interaction_labels['menu']['login']['sub_menus']['login'];
            let logout_sub_menu = translated_interaction_labels['menu']['login']['sub_menus']['logout'];

            let user_prefix = translated_interaction_labels['menu']['login']['user_prefix'];
            let user_not_logged_in = translated_interaction_labels['menu']['login']['user_not_logged_in'];
            let personal = user_data["name"] != null ? user_data["name"] : user_not_logged_in;

            $("#personal-menu li[value='login']" ).text(login_sub_menu);
            $("#personal-menu li[value='logout']" ).text(logout_sub_menu);

            $('#personal-menu .main-menu-text' ).text(user_prefix + ": " + personal);
            $('.option.personal').on('click', function() {
                let personal = $(this).attr("value");

                // LOGIN dialog
                if(personal=="login"){

                    $('#username').val("");
                    $('#password').val("");

                    originalTask = oThumbnailController.focusTask;
                    oThumbnailController.focusTask = FocusTask.Modal_Login;

                    let title = translated_interaction_labels['dialog']['login']['title'];
                    let message = translated_interaction_labels['dialog']['login']['message'];
                    let username_label = translated_interaction_labels['dialog']['login']['labels']['username'];
                    let password_label = translated_interaction_labels['dialog']['login']['labels']['password'];
                    let submit_button = translated_interaction_labels['dialog']['login']['buttons']['submit'];
                    let cancel_button = translated_interaction_labels['dialog']['login']['buttons']['cancel'];

                    $("#dialog-form-login p").html(message);
                    $("#dialog-form-login label[for='username']").text(username_label);
                    $("#dialog-form-login label[for='password']").text(password_label);
                    $("#dialog-form-login").dialog({
                        resizable: false,
                        height: "auto",
                        width: 400,
                        modal: true,
                        title: title,
                        buttons: {
                            "Submit": {
                                text: submit_button,
                                id: "login-submit-button",
                                click: function() {
                                    var username = $("#username").val();
                                    var password = $("#password").val();

                                    // Login message to the server
                                    let rq_method = "POST";
                                    let rq_url = "http://" + host + port + "/auth/login";
                                    let rq_assync = false;
                                    let data = { "username": username, "password": password }
                                    let response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json", data: data })

                                    let response_dict = response.responseJSON;
                                    let result = response_dict['result']
                                    let data_dict = response_dict['data']
                                    let error = response_dict['error']

                                    $(this).dialog("close");

                                    //window.alert(JSON.stringify(response_dict))

                                    if(result){
                                        window.location.reload(true);
                                    }
                                }
                            },
                            "Cancel": {
                                text: cancel_button,
                                click: function() {
                                    $(this).dialog("close");
                                }
                            }
                        },
                        // It needs to be able to use the Enter to Submit. Otherwise, for the Enter it goes bad and do stupid things
                        open: function() {
                            $("#dialog-form-login").keypress(function(e) {
                                if (e.keyCode == $.ui.keyCode.ENTER) {
                                    $(this).parent().find("#login-submit-button").trigger("click");
                                }
                            });
                        },
                        close: function() {
                            $(document).off("keydown.arrowKeys"); // Remove listener on close

                            // Delay needed to not propagate ESC
                            setTimeout(function () {
                                oThumbnailController.focusTask = originalTask;
                            }, 500);

                            $(this).dialog("destroy");
                          }
                    })

                // LOGOUT
                }else if(personal=="logout"){

                    // Login message to the server
                    let rq_method = "POST";
                    let rq_url = "http://" + host + port + "/auth/logout";
                    let rq_assync = false;
                    let data = '{}'
                    let response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json", data: data })

                    if(response.status == 200){
                        let response_dict = response.responseJSON;
                        let result = response_dict['result']
                        let data_dict = response_dict['data']
                        let error = response_dict['error']

                        if (result){
                            window.location.reload(true);
                        }
                    }else{
                        error = response.statusText;
                    }
                    console.log(error);
                }
            });

            //
            // VERSION
            //
//            let language_prefix = translated_interaction_labels['menu']['language']['language_prefix'];
//            selectedLanguage = language_dict[user_data['language_code']];
            $('#version-menu .main-menu-text' ).text("Version" + ": " + version);
        });

    </script>
</head>

<body>

    <div id="dialog-warning-update-failed" title="Failure" style="display:none">
        <div class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></div><p></p>
    </div>
    <div id="dialog-success-update-success" title="Success" style="display:none">
        <div class="ui-icon ui-icon-check" style="float:left; margin:12px 12px 20px 0;"></div><p></p>
    </div>
    <!-- Continue interrupted video Dialog window -->
    <div id="dialog-confirm-continue-interrupted-play" title="continue_interrupted_playback" style="display:none">
        <div class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></div>
        <p></p>
    </div>

    <!-- Login input modal window -->
    <div id="dialog-form-login" title="login" style="display:none">
        <p>qewrqew</p>
        <form method="POST">
            <fieldset>
              <label for="username">Name</label>
              <input type="text" name="name" id="username" value="" autocomplete="off" class="text ui-widget-content ui-corner-all">
              <label for="password">Password</label>
              <input type="password" name="password" autocomplete="off" id="password" value="" class="text ui-widget-content ui-corner-all">

              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>


    <div id="menu-line">

        <div id="logo-container">
            <img src="images/product-image/product-image.png" alt="Logo" id="menu-logo">
        </div>

        <div id="setting-menu" class="main-menu admin">
            <div class="main-menu-text">Server Settings</div>
            <ul id="setting-dropdown" class="dropdown">
                <li class="option setting" value="rebuild-static-db">Re-build Static DB</li>
                <li class="option setting" value="rebuild-personal-db">Re-build Personal DB</li>
                <li class="option setting" value="update-sw">Update SW</li>
            </ul>
        </div>
        <div id="language-menu" class="main-menu user">
            <div class="main-menu-text">Language: English</div>
            <ul id="language-dropdown" class="dropdown">
                <li class="option language" value="en">English</li>
                <li class="option language" value="hu">Magyar </li>
            </ul>
        </div>
        <div id="personal-menu" class="main-menu user">
            <div class="main-menu-text">No one</div>
            <ul id="personal-dropdown" class="dropdown">
                <li class="option personal" value="login">Login</li>
                <li class="option personal" value="logout">Logout</li>
            </ul>
        </div>
        <div id="version-menu" class="main-menu user">
            <div class="main-menu-text">Version:</div>
        </div>

<!--
        <div class="main-menu empty">
            <div class="main-menu-text">&nbsp; &nbsp; &nbsp; </div>
        </div>
-->

    </div>

    <div id="viewport">

        <!-- Info section -->
        <div id="static-section">
            <div id="description-section">
                <div id="description-text-div">
                    <div id="description-text-wrapper">

                        <div id="description-text-title"></div>
                        <div id="description-text-container-outer">
                            <div id="description-text-container">
                                <div id="description-text-extra">
                                    <div id="description-text-extra-date"></div>
                                    <div id="description-text-extra-length"></div>
                                    <div id="description-text-extra-block">
                                        <div id="description-text-extra-block-origin"></div>
                                        <div id="description-text-extra-block-genre"></div>
                                        <div id="description-text-extra-block-theme"></div>
                                    </div>
                                </div>

                                <div id="description-text-area-div">
                                    <div id="description-text-storyline" class="with-scrollbar"></div>
                                </div>
                            </div>
                            <div id="description-text-credentials" class="with-scrollbar"></div>
                        </div>
                        <div id="description-appendix">
                            <div id="description-appendix-download"></div>
                            <div id="description-appendix-play"></div>
                        </div>

                        <div id="description-tagging"></div>
                        <div id="description-rating"></div>

                    </div>
                </div>
                <div id="description-image">
                </div>

            </div>
            <div id="history-section">
                <div id="history-section-text"></div>
                <div id="history-section-link"></div>
            </div>
        </div>

        <!-- scroll section -->
        <div>
            <div id="scroll-section">
            </div>
        </div>

        <!-- spinner -->
        <div id="spinner">
            <img src="spinner.gif">
        </div>
    </div>

    <!-- Video container -->
    <div id="video-container">
        <video height="0" id="video_player"></video>
    </div>
    <div>
        <div id="overlay"></div>
        <div id="modal">
            <div id="close-button">❌</div>
            <pre><code id="text-content"></code></pre>
        </div>
    </div>

</body>
</html>