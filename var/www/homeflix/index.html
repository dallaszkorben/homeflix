<meta charset="UTF-8" comntent="text/html;charset=utf-8" http-equiv="Content-Type">

<!DOCTYPE html>
<html>

<head>

    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/js-jaml/js-yaml.js"></script>

    <link href="script/fancybox/jquery.fancybox.min.css" rel="stylesheet" />
    <script src="script/fancybox/jquery.fancybox.min.js"></script>

    <link rel="stylesheet" href="script/jquery-ui/jquery-ui.css">
    <script src="script/jquery-ui/jquery-ui.js"></script>

    <link rel="stylesheet" href="script/highlight/styles/atom-one-dark.min.css">
    <script src="script/highlight/highlight.min.js"></script>

    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="container.js"></script>
    <script src="generators.js"></script>
    <script src="selection_components.js"></script>

    <link rel="stylesheet" href="stylesheet.css">
    <link rel="icon" href="favicon.ico">

    <script>

        // ========================================
        // GLOBAL CONFIGURATION AND INITIALIZATION
        // ========================================

        // LocalStorage prefix for all HomeFlix data
        let PREFIX_LOCAL_STORAGE = "homeflix"

        // Server connection configuration
        // Automatically detects current hostname for flexibility across environments
        let host = location.hostname;  // Auto-detect: localhost, 192.168.x.x, etc.
        let port = ":80";              // Standard HTTP port

        // Available language options for the interface
        let language_dict = {"hu": "Magyar", "en": "English"};

        // ========================================
        // SESSION RESTORATION
        // ========================================
        // Attempt to restore previous user session by calling login without credentials
        // This allows users to stay logged in across browser sessions
        let rq_method = "POST";
        let rq_url = "http://" + host + port + "/auth/login";
        let rq_data = {"username": null, "password": null};  // No credentials = session check
        let rq_assync = false;  // Synchronous to ensure user data is available before UI loads
        let result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, data: rq_data, dataType: "json" });
        let user_data = result.responseJSON['data'];

        // If session restoration fails, use default guest user settings
        if(!result.responseJSON['result'] || Object.keys(user_data).length === 0){
            user_data = {
                language_code: "en",                           // Default to English
                name: null,                                    // No user name (guest)
                is_admin: true,                                // Guest has admin privileges
                descriptor_color: 'rgb(129, 60, 41)',          // Brown color for description section
                always_show_original_title: true,              // Show original movie titles
                show_lyrics_anyway: true,                      // Display lyrics when available
                show_storyline_anyway: true,                   // Display plot summaries
                play_continuously: true                        // Auto-play next episode/movie
            }
        }

        // ========================================
        // GLOBAL DATA VARIABLES
        // ========================================
        // These variables store application data loaded from the server
        let version;                        // Application version string
        let translated_labels;              // UI labels in user's language
        let translated_genre_movie;         // Movie genre translations
        let translated_categories;          // Content category translations
        let translated_themes;              // Theme/topic translations
        let translated_countries;           // Country name translations
        let all_movie_director_list;        // Complete list of directors
        let all_movie_writer_list;          // Complete list of writers
        let all_movie_actor_list;           // Complete list of actors
        let all_movie_voice_list;           // Complete list of voice actors
        let all_movie_rate_list;            // Available rating values

        // ========================================
        // APPLICATION VERSION LOADING
        // ========================================
        rq_method = "GET";
        rq_url = "http://" + host + port + "/info/version";
        rq_assync = false;  // Synchronous to ensure version is available
        result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
        result = result.responseJSON;
        version = result['version'];

        // ========================================
        // TRANSLATION DATA LOADING
        // ========================================
        // Load all translation dictionaries based on user's language preference
        // All requests are synchronous to ensure data is available before UI initialization
        let data = {}  // Empty data object for requests without parameters

        // DICTIONARY-TYPE TRANSLATIONS (key-value pairs)
        // Load UI interaction labels (buttons, menus, dialogs)
        translated_interaction_labels = getAllElements("dict", data, "/translate/interaction_labels/lang/" + user_data['language_code'])

        // Load content category names (movie, music, documentary, etc.)
        translated_categories = getAllElements("dict", data, "/translate/categories/lang/" + user_data['language_code'])

        // Load music genre translations
        translated_genre_music = getAllElements("dict", data, "/translate/genres/category/music/lang/" + user_data['language_code'])

        // Load content rating/level translations (G, PG, R, etc.)
        translated_levels = getAllElements("dict", data, "/translate/levels/lang/" + user_data['language_code'])

        // Load general UI labels
        translated_labels = getAllElements("dict", data, "/translate/labels/lang/" + user_data['language_code'])

        // Load country name translations
        translated_countries = getAllElements("dict", data, "/translate/countries/lang/" + user_data['language_code'])

        // Load movie genre translations (action, comedy, drama, etc.)
        translated_genre_movie = getAllElements("dict", data, "/translate/genres/category/movie/lang/" + user_data['language_code'])

        // Load theme/topic translations (war, love, friendship, etc.)
        translated_themes = getAllElements("dict", data, "/translate/themes/lang/" + user_data['language_code'])

        // ========================================
        // METADATA COLLECTION LOADING
        // ========================================
        // Load complete lists of people and metadata for search/filter functionality
        data = {
            "category": "movie",    // Focus on movie content
            "limit": 9999,         // Get all available entries
        };

        // Load all movie directors for autocomplete/search
        all_movie_director_list = getAllElements("list", data, "/collect/directors")

        // Load all movie writers for autocomplete/search
        all_movie_writer_list = getAllElements("list", data, "/collect/writers")

        // Load all movie actors for autocomplete/search
        all_movie_actor_list = getAllElements("list", data, "/collect/actors")

        // Load all voice actors for autocomplete/search
        all_movie_voice_list = getAllElements("list", data, "/collect/voices")

        // ========================================
        // TAG DICTIONARY LOADING
        // ========================================
        // Load all available tags as a dictionary (value->value mapping)
        // Used for tag-based filtering and search functionality
        all_movie_tag_dict = getAllElements("list_to_dict", data, "/collect/tags")



        // ========================================
        // ASYNC UTILITIES
        // ========================================
        // Utility for adding delays in async functions: await delay(100);
        const delay = ms => new Promise(res => setTimeout(res, ms));

        /**
         * Generic function to fetch and process data from API endpoints
         * @param {string} type - Data processing type: 'dict', 'list', or 'list_to_dict'
         * @param {Object} data - Request parameters to send with the API call
         * @param {string} path - API endpoint path
         * @returns {Map|Array} Processed data structure
         */
        function getAllElements(type, data, path){
            // Supported types:
            // - 'dict': Returns sorted Map from key-value pairs
            // - 'list': Returns array as-is
            // - 'list_to_dict': Converts array to Map where each value becomes both key and value

            // Make synchronous API request
            rq_method = "GET";
            rq_url = "http://" + host + port + path;
            rq_assync = false;

            // Send request with or without data parameters
            if(Object.keys(data).length === 0){
                result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json"});
            }else{
                result = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json", data: data });
            }

            // Process response based on requested type
            if(type == "list"){
                // Return array directly
                output = result.responseJSON["data"];
            }else if (type == "dict"){
                // Convert object to sorted Map
                output = new Map(
                    Object.entries(result.responseJSON["data"])
                        .sort((a, b) => {
                            return a[1] < b[1] ? -1 : (a[1] > b[1] ? 1 : 0);
                        })
                );
            }else if (type == "list_to_dict"){
                // Convert array to Map where each value is both key and value (for tags)
                output = new Map(
                    Object.entries(result.responseJSON["data"])
                        .map(([key, value]) => [value, value])  // Transform to [value, value] pairs
                        .sort((a, b) => {
                            return a[1] < b[1] ? -1 : (a[1] > b[1] ? 1 : 0);
                        })
                );
            }

            return output;
        }

        /**
         * Debug utility to print values to console
         * Handles both objects and primitive values
         * @param {*} value - Value to print (any type)
         */
        function print(value){
            let stringValue = typeof value === 'object' ? JSON.stringify(value) : String(value);
            console.log(stringValue);
        }



        // ========================================
        // LOCAL STORAGE UTILITIES
        // ========================================
        /**
         * Retrieve value from localStorage
         * @param {string} key - Storage key
         * @param {*} defaultValue - Default value if key not found (currently unused)
         * @returns {string|null} Stored value or null
         */
        function getLocalStorage(key, defaultValue){
            let value = localStorage.getItem(key);
            return value;
        }

        /**
         * Store value in localStorage
         * @param {string} key - Storage key
         * @param {string} value - Value to store
         */
        function setLocalStorage(key, value){
            localStorage.setItem(key,value);
        }

        /**
         * Remove single item from localStorage
         * @param {string} key - Storage key to remove
         */
        function deleteLocalStorage(key) {
            localStorage.removeItem(key);
        }

        /**
         * Remove all localStorage items with keys starting with given prefix
         * Used for clearing cached data when rebuilding databases
         * @param {string} prefix - Key prefix to match
         */
        function deleteLocalStorageStartingWith(prefix) {
            const keysToDelete = [];

            // First collect all matching keys (avoid modifying during iteration)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    keysToDelete.push(key);
                }
            }

            // Then remove them safely
            keysToDelete.forEach(key => {
                localStorage.removeItem(key);
            });
        }



        // ========================================
        // UI LAYOUT AND STYLING CONSTANTS
        // ========================================
        // These constants define the visual appearance and dimensions of UI components
        // Values are later applied to CSS custom properties for dynamic styling

        // THUMBNAIL STYLING
        const thumbnail_border_width = 7;                    // Red border around focused thumbnail
        const thumbnail_border_color = 'rgb(200, 0, 0)';     // Red focus indicator
        const thumbnail_image_width = 160;                   // Standard thumbnail width
        const thumbnail_image_height = 208;                  // Standard thumbnail height (movie poster ratio)
        const thumbnail_background = 'rgb(100, 100, 100)';   // Gray background for missing images

        const thumbnail_text_font_size = 30;                 // Font size for thumbnail titles
        const thumbnail_text_font_color = 'rgb(7, 24, 101)'  // Dark blue text color
        const thumbnail_text_font_shadow_color = 'rgb(255,255,255)' // White text shadow for readability

        // CONTAINER STYLING (groups of thumbnails)
        const thumbnail_container_border_width = 4           // Border around thumbnail containers
        const thumbnail_container_border_color = 'rgb(100, 100, 100)'; // Gray container borders
        const thumbnail_container_background = 'rgb(100, 100, 100)';   // Gray container background
        // Calculate total container height including borders
        const thumbnail_container_height = thumbnail_image_height + (2 * thumbnail_border_width) + (2 * thumbnail_container_border_width)

        // CONTAINER BLOCK STYLING (wrapper around containers)
        const thumbnail_container_block_border_width = 1;
        const thumbnail_container_block_border_color = 'rgb(0, 0, 0)';  // Black borders
        const thumbnail_container_block_background = 'rgb(40, 40, 40)'; // Dark gray background

        // SCROLL SECTION (main content area with thumbnails)
        // IMPORTANT: Must match description_section_border_width to prevent horizontal scrollbar
        const scroll_section_border_width = 0;
        const scroll_section_border_color = 'rgb(30, 30, 30)';
        const scroll_section_background = 'rgb(30, 30, 30)';  // Dark background
        const scroll_section_height_portion = 50;             // Takes 50% of viewport height

        // STATIC SECTION (description area)
        const static_section_height_portion = 50;             // Takes remaining 50% of viewport height

        // HISTORY SECTION (breadcrumb navigation)
        const history_section_background = 'rgb(100, 100, 100)'; // Medium gray background
        const history_section_border_width = 1
        const history_section_border_color = 'rgb(0, 0, 0)';  // Black border
        const history_section_font_color = 'rgb(0, 0, 0)';    // Black text

        // Check if device is mobile and adjust height accordingly
        let history_section_height = undefined;
        let history_section_font_size = undefined;
        if (window.innerWidth <= 980) {
            history_section_font_size = 30; // Navigation text size
            history_section_height = 100;   // Increased height for mobile
        }else{
            history_section_font_size = 22;                             // Navigation text size
            history_section_height = history_section_font_size + 15;  // Fixed height for navigation bar
        }

        // DESCRIPTION SECTION (movie details)
        // IMPORTANT: Must match scroll_section_border_width to prevent horizontal scrollbar
        const description_section_border_width = 0;
        const description_section_border_color = 'rgb(9, 60, 41)';    // Dark green border
        const description_section_background = 'rgb(171, 253, 176)';  // Light green background

        // DESCRIPTION TEXT SIZING
        const description_text_extra_font_size = 1.6;         // Large text for title/metadata (em units)
        const description_text_storyline_font_size = 1.3;     // Medium text for plot summary
        const description_text_credentials_font_size = 1.3;   // Medium text for cast/crew

        const description_text_storyline_width = 45;          // Storyline takes 45% of description width

        // DESCRIPTION POSITIONING
        const description_text_wrapper_top = scroll_section_border_width;   // Align with scroll section
        const description_text_wrapper_left = scroll_section_border_width;  // Align with scroll section

        t = document.querySelector(':root');

        // Thumbnail
        setCSSProperties({
            '--thumbnail-border-width': thumbnail_border_width + 'px'
        });
        setCSSProperties({
            '--thumbnail-border-color': thumbnail_border_color
        });
        setCSSProperties({
            '--thumbnail-image-height': thumbnail_image_height + 'px'
        });
        setCSSProperties({
            '--thumbnail-image-width': thumbnail_image_width + 'px'
        });
        setCSSProperties({
            '--thumbnail_background': thumbnail_background
        });

        setCSSProperties({
            '--thumbnail-text-font-size': thumbnail_text_font_size + 'px'
        });
        setCSSProperties({
            '--thumbnail-text-font-color': thumbnail_text_font_color
        });
        setCSSProperties({
            '--thumbnail-text-font-shadow-color': thumbnail_text_font_shadow_color
        });

        // Container
        setCSSProperties({
            '--thumbnail-container-border-width': thumbnail_container_border_width + 'px'
        });
        setCSSProperties({
            '--thumbnail-container-border-color': thumbnail_container_border_color
        });
        setCSSProperties({
            '--thumbnail-container-background': thumbnail_container_background
        });
        setCSSProperties({
            '--thumbnail-container-height': thumbnail_container_height + 'px'
        });

        // Container block
        setCSSProperties({
            '--thumbnail-container-block-border-color': thumbnail_container_block_border_color
        });
        setCSSProperties({
            '--thumbnail-container-block-background': thumbnail_container_block_background
        });
        setCSSProperties({
            '--thumbnail-container-block-border-width': thumbnail_container_block_border_width + 'px'
        });

        // Scroll section
        t.style.setProperty('--scroll-section-border-width', scroll_section_border_width + 'px');
        t.style.setProperty('--scroll-section-border-color', scroll_section_border_color);
        t.style.setProperty('--scroll-section-background', scroll_section_background);
        t.style.setProperty('--scroll-section-height-portion', scroll_section_height_portion + '%');

        // Static section
        t.style.setProperty('--static-section-height-portion', static_section_height_portion + '%');

        // History section
        t.style.setProperty('--history-section-background', history_section_background);
        t.style.setProperty('--history-section-border-width', history_section_border_width + 'px');
        t.style.setProperty('--history-section-border-color', history_section_border_color);
        t.style.setProperty('--history-section-font-size', history_section_font_size + 'px');
        t.style.setProperty('--history-section-font-color', history_section_font_color);
        t.style.setProperty('--history-section-height', history_section_height + 'px');

        // Description section
        t.style.setProperty('--description-section-border-width', description_section_border_width + 'px');
        t.style.setProperty('--description-section-border-color', description_section_border_color);
        t.style.setProperty('--description-section-background', description_section_background);

        t.style.setProperty('--description-text-wrapper-top', description_text_wrapper_top + 'px');
        t.style.setProperty('--description-text-wrapper-left', description_text_wrapper_left + 'px');
        t.style.setProperty('--description-text-extra-font-size', description_text_extra_font_size + 'em');
        t.style.setProperty('--description-text-storyline-font-size', description_text_storyline_font_size + 'em');
        t.style.setProperty('--description-text-credentials-font-size', description_text_credentials_font_size + 'em');

        t.style.setProperty('--description-text-storyline-width', description_text_storyline_width + '%');

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        /**
         * Generate random integer within specified range
         * @param {number} min - Minimum value (inclusive)
         * @param {number} max - Maximum value (exclusive)
         * @returns {number} Random integer between min and max-1
         */
        function generateRandom(min = 0, max = 100) {
            // Calculate the range
            let difference = max - min;
            // Generate random decimal between 0 and 1
            let rand = Math.random();
            // Scale to desired range and floor to integer
            rand = Math.floor(rand * difference);
            // Add minimum value to shift range
            rand = rand + min;
            return rand;
        }

        /**
         * Get translated text for content level/rating
         * @param {string} level - Content level key
         * @returns {string} Translated level text or original if not found
         */
        function get_translated_level(level){
            if (translated_levels.hasOwnProperty(level)) {
                return translated_levels[level];
            } else {
                return level; // Fallback to original if translation not found
            }
        }

        // TODO: Implement similar translation functions for other dictionaries
        // (translated_categories, translated_themes, translated_countries, etc.)


        // This code is for disabling the page refresh with swipe down
        // on the 'scroll-section' but it is allowed on the 'static-section'
        document.addEventListener('touchmove', function(e) {
            // Only prevent if touch is within scroll-section
            if (e.target.closest('#scroll-section')) {
                e.preventDefault();
            }
        }, { passive: false });

        $(document).ready(function () {

            // ========================================
            // TOUCH GESTURE CONFIGURATION
            // ========================================
            // Load touch swipe configuration from config.js
            // SWIPE_RANGES defines distance thresholds and corresponding command counts:
            // - 50-79px: 1 command (short swipe)
            // - 80-159px: 1 command (medium swipe)
            // - 160-239px: 2 commands (long swipe - moves 2 positions)
            // - 240-319px: 3 commands (very long swipe - moves 3 positions)
            // - 320-999px: 4 commands (extra long swipe - moves 4 positions)
            const SWIPE_RANGES = HomeFlix.TOUCH.SWIPE_RANGES;
            const MIN_SWIPE_DISTANCE = HomeFlix.TOUCH.MIN_SWIPE_DISTANCE; // Minimum 50px to register as swipe

            // ========================================
            // CONTAINER VISIBILITY HELPER FUNCTIONS
            // ========================================
            // Calculate which container is at the top of the visible scroll area
            function getFirstVisibleContainerIndex() {
                let scrollSection = oThumbnailController.getScrollSection();
                let sectionScrollTop = scrollSection.domScrollSection.scrollTop();
                let containerBlockHeight = scrollSection.domThumbnailContainerBlocks.eq(0).outerHeight(true);
                return Math.floor(sectionScrollTop / containerBlockHeight);
            }

            // Calculate which container is at the bottom of the visible scroll area
            function getLastVisibleContainerIndex() {
                let scrollSection = oThumbnailController.getScrollSection();
                let sectionHeight = scrollSection.domScrollSection.height();
                let sectionScrollTop = scrollSection.domScrollSection.scrollTop();
                let containerBlockHeight = scrollSection.domThumbnailContainerBlocks.eq(0).outerHeight(true);
                let visibleContainers = Math.floor(sectionHeight / containerBlockHeight);
                return Math.min(scrollSection.numberOfContainers - 1, Math.floor(sectionScrollTop / containerBlockHeight) + visibleContainers - 1);
            }

            //
            // if not logged in -> different descriptor color
            //
            t.style.setProperty('--description-section-left-background', user_data['descriptor_color']);

            // Load Card Menu
            rq_method = "GET";
            rq_url = "http://" + host + port + "/personal/card_menu/get";
            rq_assync = false;
            response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
            let mainMenuDict;
            if(response.status == 200 && response.responseJSON["result"]){
                mainMenuDict = response.responseJSON["data"];
            //Card Menu Error - can not continue without menu
            }else{
                console.error(response.responseJSON["error"])
                return;
            }

            let menu = new GeneralRestGenerator(mainMenuDict, user_data['language_code'], "");

            // this triggers the produceContainers()
            let oThumbnailController = new ThumbnailController(menu);
            let oScrollSection = oThumbnailController.getScrollSection();

            // -----------------------
            // Listener configurations
            // -----------------------

            //
            // Description section resize observer
            //

            // Triggered if the size of the description section changed - I have to resize the Description Image
            const resizeObserver = new ResizeObserver(entries => {

                // I do the refresh through the ThumbnailController
                oThumbnailController.resizeDescriptionSection();
            });
            const domDescSectSection = document.querySelector("#description-section");
            resizeObserver.observe(domDescSectSection);

            // Mouse enters an image
            $('.description-rating-rate img').hover(function() {
                const currentImg = $(this);
                if (currentImg.attr('src') === 'images/rating/NotSelected-x.png') {
                    currentImg.attr('src', 'images/rating/NotSelected-x-focus.png');
                } else if (currentImg.is(selectedImg)) {
                    currentImg.attr('src', currentImg.data('focus')); // Hovering over selected image
                }
            }, function() {
                const currentImg = $(this);
                if (currentImg.attr('src') === 'images/rating/NotSelected-x-focus.png') {
                    currentImg.attr('src', 'images/rating/NotSelected-x.png');
                } else if (currentImg.is(selectedImg)) {
                    currentImg.attr('src', currentImg.data('selected')); // Leaving selected image
                }
            });

            // Image clicked
            $('.description-rating-rate img').click(function() {
                if (selectedImg) {
                    // Reset the previous selected image back to not selected
                    selectedImg.attr('src', 'images/rating/NotSelected-x.png');
                }

                // Set the new selected image
                selectedImg = $(this);
                selectedImg.attr('src', selectedImg.data('selected'));
            });

            // ========================================
            // KEYBOARD EVENT HANDLING
            // ========================================
            // Maps keyboard inputs to navigation actions for TV-like remote control experience
            $(document).on('keydown', function (e) {
                // Define action functions for each key
                function clickOnThumbnail() {
                    oThumbnailController.enter(e);  // Enter/Space: Select current thumbnail
                }
                function clickOnEscape() {
                    oThumbnailController.escape();  // Escape: Go back/cancel
                }
                function arrowLeft() {
                    oThumbnailController.arrowLeft();  // Left arrow: Previous thumbnail
                }
                function arrowUp() {
                    oThumbnailController.arrowUp();    // Up arrow: Previous container/row
                }
                function arrowRight() {
                    oThumbnailController.arrowRight(); // Right arrow: Next thumbnail
                }
                function arrowDown() {
                    oThumbnailController.arrowDown();  // Down arrow: Next container/row
                }
                function tab() {
                    oThumbnailController.tab();        // Tab: Special navigation function
                }

                // Key code mapping: keyCode -> function
                // 27=Escape, 13=Enter, 32=Space, 37=Left, 38=Up, 39=Right, 40=Down, 9=Tab
                var act = { 27: clickOnEscape, 13: clickOnThumbnail, 32: clickOnThumbnail, 37: arrowLeft, 38: arrowUp, 39: arrowRight, 40: arrowDown, 9: tab };
                if (act[e.keyCode])
                    var a = new act[e.keyCode]; // Execute corresponding action
            });

            // ========================================
            // TOUCH GESTURE IMPLEMENTATION
            // ========================================
            // Variables to track touch start position and context
            let touchStartX, touchStartY, touchInDescriptionSection;

            // TOUCH START EVENT - Capture initial touch position
            $(document).on('touchstart', function (e) {
                // Record starting coordinates of the touch
                touchStartX = e.changedTouches[0].clientX;
                touchStartY = e.changedTouches[0].clientY;
                // Check if touch started in description section (to disable swipe navigation there)
                touchInDescriptionSection = $(e.target).closest('#description-section').length > 0;
            });

            // TOUCH END EVENT - Process swipe gestures
            $(document).on('touchend', function (e) {
                // Skip gesture processing if touch was in description section
                // (allows normal scrolling/interaction in description area)
                if (touchInDescriptionSection) return;

                // Calculate touch movement distance
                let touchEndX = e.changedTouches[0].clientX;
                let touchEndY = e.changedTouches[0].clientY;
                let deltaX = touchEndX - touchStartX; // Horizontal movement
                let deltaY = touchEndY - touchStartY; // Vertical movement

                // Determine number of navigation commands based on swipe distance
                // Uses SWIPE_RANGES configuration to map distance to command count
                function getCommandCount(distance) {
                    for (let range of SWIPE_RANGES) {
                        if (distance >= range.min && distance <= range.max) {
                            return range.commands;
                        }
                    }
                    return 0; // Distance too small, no commands
                }

                // HORIZONTAL SWIPE PROCESSING (thumbnail navigation within container)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) >= MIN_SWIPE_DISTANCE) {
                    let steps = getCommandCount(Math.abs(deltaX));

                    let scrollSection = oThumbnailController.getScrollSection();
                    let containerIndex = scrollSection.currentContainerIndex;
                    let currentFocused = scrollSection.focusedThumbnailList[containerIndex];
                    let domThumbnails = $('#container-' + containerIndex + ' .thumbnail');
                    let totalThumbnails = domThumbnails.length;

                    let indexList = scrollSection.getIndexOfFirstAndLastThumbnailInViewPort();

                    // SWIPE RIGHT = MOVE LEFT (previous thumbnails)
                    if (deltaX > 0) {

                        scrollSection.setFocusToThumbnail(indexList[0]);

                        // Prevent navigation beyond first thumbnail
                        if (currentFocused === 0) {
                            return; // Already at first thumbnail, no circular navigation
                        }
                        // Execute multiple left arrow commands based on swipe distance
                        for (let i = 0; i < steps; i++) {
                            if (scrollSection.focusedThumbnailList[containerIndex] > 0) {
                                oThumbnailController.arrowLeft();
                            }
                        }

                    // SWIPE LEFT = MOVE RIGHT (next thumbnails)
                    } else {

                        scrollSection.setFocusToThumbnail(indexList[1]);

                        // Prevent navigation beyond last thumbnail
                        if (currentFocused === totalThumbnails - 1) {
                            return; // Already at last thumbnail, no circular navigation
                        }
                        // Execute multiple right arrow commands based on swipe distance
                        for (let i = 0; i < steps; i++) {
                            if (scrollSection.focusedThumbnailList[containerIndex] < totalThumbnails - 1) {
                                oThumbnailController.arrowRight();
                            }
                        }
                    }
                }
                // VERTICAL SWIPE PROCESSING (container navigation between rows)
                else if (Math.abs(deltaY) >= MIN_SWIPE_DISTANCE) {
                    let steps = getCommandCount(Math.abs(deltaY));
                    let scrollSection = oThumbnailController.getScrollSection();
                    let currentContainer = scrollSection.currentContainerIndex;
                    let totalContainers = scrollSection.numberOfContainers;

                    if (deltaY > 0) {
                        // SWIPE DOWN = MOVE UP (previous containers/rows)
                        // Prevent navigation beyond first container
                        if (currentContainer === 0) {
                            return; // Already at first container, no circular navigation
                        }
                        // Execute multiple up arrow commands based on swipe distance
                        for (let i = 0; i < steps; i++) {
                            if (scrollSection.currentContainerIndex > 0) {
                                oThumbnailController.arrowUp();
                            }
                        }
                    } else {
                        // SWIPE UP = MOVE DOWN (next containers/rows)
                        // Prevent navigation beyond last container
                        if (currentContainer === totalContainers - 1) {
                            return; // Already at last container, no circular navigation
                        }
                        // Execute multiple down arrow commands based on swipe distance
                        for (let i = 0; i < steps; i++) {
                            if (scrollSection.currentContainerIndex < totalContainers - 1) {
                                oThumbnailController.arrowDown();
                            }
                        }
                    }
                }
            });

            // Mobile arrow navigation click handlers
            $('#container-controllers-up-down img[src*="arrow-mobile-up.png"]').on('click', function() {
                oThumbnailController.arrowUp();
            });

            $('#container-controllers-up-down img[src*="arrow-mobile-down.png"]').on('click', function() {
                oThumbnailController.arrowDown();
            });

            /********
             *      *
             * MENU *
             *      *
             ********/

            let openDropdown = false;

            // If the mouse is close to the top, the menu appears
            $(document).on('mousemove', function(event) {
                var mouseY = event.clientY;
                if (mouseY <= 60) {
                    $('#menu-line').addClass('show');
                } else if(!openDropdown){
                    $('#menu-line').removeClass('show');
                }
            });
            // To show the menu
            // $('#menu-line').addClass('show');

            // If the mouse is over the language menu, the dropdown appears
            // If the mouse is over the setting menu, the dropdown appears
            $('.main-menu').hover(function() {
                $(this).find('.dropdown').slideToggle(200);
            });

            // If I hover on the dropdown menu, the mouse can lower than 30 pxs
            $('.main-menu').hover(
                function() {
                    openDropdown = true;
                },
                function(){
                    openDropdown = false;
                }
            );


            //
            // LANGUAGE
            //
            // Set the default language in the menu
            let menu_dict = translated_interaction_labels.get('menu')
            let language_prefix = menu_dict['language']['language_prefix'];
            selectedLanguage = language_dict[user_data['language_code']];
            $('#language-menu .main-menu-text' ).text(language_prefix + ": " + selectedLanguage);

            // Select on language from the dropdown list
            $('.option.language').on('click', function() {
                let selectedLanguage = $(this).text();
                $('#language-menu .main-menu-text' ).text(language_prefix + ": " + selectedLanguage);
                // $('#language-dropdown').slideUp(200); // To bring back the menu


                // Update the language in the DB
                let rq_method = "POST";
                let rq_url = "http://" + host + port + "/personal/user_data/update";
                let rq_assync = false;
                let data = {"language_code": $(this).attr("value")}
                let response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json", data: data })

                // Restart the browser
                window.location.reload();
            });

            //
            // Server Setting
            //
            let server_setting_menu = menu_dict['server']['menu'];
            let rebuild_static_db_menu = menu_dict['server']['sub_menus']['rebuild_static_db'];
            let rebuild_personal_db_menu = menu_dict['server']['sub_menus']['rebuild_personal_db'];
            let update_software_menu = menu_dict['server']['sub_menus']['update_software'];

            $("#setting-menu .main-menu-text").text(server_setting_menu);
            $("#setting-menu li[value='rebuild-static-db']").text(rebuild_static_db_menu);
            $("#setting-menu li[value='rebuild-personal-db']").text(rebuild_personal_db_menu);
            $("#setting-menu li[value='update-sw']").text(update_software_menu);

            $('.option.setting').on('click', function() {
                let setting = $(this).attr("value");

                if(setting=="rebuild-static-db"){

                    Generator.startSpinner();

                     // Delete all request/response in the Local Storage
                     deleteLocalStorageStartingWith(PREFIX_LOCAL_STORAGE);

                    setTimeout(function(){
                        rq_method = "POST";
                        rq_url = "http://" + host + port + "/control/rebuild/db/static";
                        rq_assync = false;
                        response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
                        rebuild_result = response.responseJSON;

                        window.location.reload(true);
                    }, 100);

                }else if(setting=="rebuild-personal-db"){

                    Generator.startSpinner();

                    setTimeout(function(){
                        rq_method = "POST";
                        rq_url = "http://" + host + port + "/control/rebuild/db/personal";
                        rq_assync = false;
                        response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
                        rebuild_result = response.responseJSON;

                        window.location.reload(true);
                    }, 100);

                }else if(setting=="update-sw"){

                    Generator.startSpinner();

                    // Delete all request/response in the Local Storage
                    deleteLocalStorageStartingWith(PREFIX_LOCAL_STORAGE);

                    setTimeout(function(){
                        rq_method = "POST";
                        rq_url = "http://" + host + port + "/control/update/sw";
                        rq_assync = false;
                        response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json" });
                        response_dict = response.responseJSON;

                        response_update = response_dict["update"]
                        response_reload = response_dict["reload"]

                        console.log("Update response: " + response_update);
                        console.log("Reload response: " + response_reload);

                        Generator.stopSpinner();

                        if(response.status != 200){
                            $("#dialog-warning-update-failed p").html("Something went wrong.<br>" + response.statusText + "<br>");
                            $("#dialog-warning-update-failed" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });

                        // The update failed - there was NO restart
                        }else if(response_update['result'] != "SUCCESS"){

                            $("#dialog-warning-update-failed p").html("Update failed.<br>" + response_update['message'] + "<br><br>Command: " + response_update['command'][0]);
                            $("#dialog-warning-update-failed" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });

                        // The reload failed - update was successful
                        }else if(response_reload['result'] != "SUCCESS"){

                            $("#dialog-warning-update-failed p").html("Software update was successful, but the server reload failed.<br>" + response_reload['message'] + "<br><br>Command: " + response_reload['command'] + "<br><br>The easiest way to reload the server is to turn OFF/ON the machine.");
                            $("#dialog-warning-update-failed" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });

                        }else{

                            $("#dialog-success-update-success p").html("Software update was successful");
                            $("#dialog-success-update-success" ).dialog({
                                resizable: false,
                                height: "auto",
                                width: 400,
                                modal: true,
                                buttons: {
                                    "OK": function() {
                                        $( this ).dialog( "close" );
                                        window.location.reload(true);
                                    }
                                }
                            });
                        }
                    }, 100);
                }
            });

            //
            // LOGIN
            //
            let login_sub_menu = menu_dict['login']['sub_menus']['login'];
            let logout_sub_menu = menu_dict['login']['sub_menus']['logout'];

            let user_prefix = menu_dict['login']['user_prefix'];
            let user_not_logged_in = menu_dict['login']['user_not_logged_in'];
            let personal = user_data["name"] != null ? user_data["name"] : user_not_logged_in;

            $("#personal-menu li[value='login']" ).text(login_sub_menu);
            $("#personal-menu li[value='logout']" ).text(logout_sub_menu);

            $('#personal-menu .main-menu-text' ).text(user_prefix + ": " + personal);
            $('.option.personal').on('click', function() {
                let personal = $(this).attr("value");

                // LOGIN dialog
                if(personal=="login"){

                    $('#username').val("");
                    $('#password').val("");

                    originalTask = oThumbnailController.focusTask;
                    oThumbnailController.focusTask = FocusTask.Modal_Login;

                    let dialog_dict = translated_interaction_labels.get('dialog')
                    let title = dialog_dict['login']['title'];
                    let message = dialog_dict['login']['message'];
                    let username_label = dialog_dict['login']['labels']['username'];
                    let password_label = dialog_dict['login']['labels']['password'];
                    let submit_button = dialog_dict['login']['buttons']['submit'];
                    let cancel_button = dialog_dict['login']['buttons']['cancel'];

                    $("#dialog-form-login p").html(message);
                    $("#dialog-form-login label[for='username']").text(username_label);
                    $("#dialog-form-login label[for='password']").text(password_label);
                    $("#dialog-form-login").dialog({
                        resizable: false,
                        height: "auto",
                        width: 400,
                        modal: true,
                        title: title,
                        buttons: {
                            "Submit": {
                                text: submit_button,
                                id: "login-submit-button",
                                click: function() {
                                    var username = $("#username").val();
                                    var password = $("#password").val();

                                    // Login message to the server
                                    let rq_method = "POST";
                                    let rq_url = "http://" + host + port + "/auth/login";
                                    let rq_assync = false;
                                    let data = { "username": username, "password": password }
                                    let response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json", data: data })

                                    let response_dict = response.responseJSON;
                                    let result = response_dict['result']
                                    let data_dict = response_dict['data']
                                    let error = response_dict['error']

                                    $(this).dialog("close");

                                    //window.alert(JSON.stringify(response_dict))

                                    if(result){
                                        window.location.reload(true);
                                    }
                                }
                            },
                            "Cancel": {
                                text: cancel_button,
                                click: function() {
                                    $(this).dialog("close");
                                }
                            }
                        },
                        // It needs to be able to use the Enter to Submit. Otherwise, for the Enter it goes bad and do stupid things
                        open: function() {
                            $("#dialog-form-login").keypress(function(e) {
                                if (e.keyCode == $.ui.keyCode.ENTER) {
                                    $(this).parent().find("#login-submit-button").trigger("click");
                                }
                            });
                        },
                        close: function() {
                            $(document).off("keydown.arrowKeys"); // Remove listener on close

                            // Delay needed to not propagate ESC
                            setTimeout(function () {
                                oThumbnailController.focusTask = originalTask;
                            }, 500);

                            $(this).dialog("destroy");
                          }
                    })

                // LOGOUT
                }else if(personal=="logout"){

                    // Login message to the server
                    let rq_method = "POST";
                    let rq_url = "http://" + host + port + "/auth/logout";
                    let rq_assync = false;
                    let data = '{}'
                    let response = $.getJSON({ method: rq_method, url: rq_url, async: rq_assync, dataType: "json", data: data })

                    if(response.status == 200){
                        let response_dict = response.responseJSON;
                        let result = response_dict['result']
                        let data_dict = response_dict['data']
                        let error = response_dict['error']

                        if (result){
                            window.location.reload(true);
                        }
                    }else{
                        error = response.statusText;
                    }
                    console.log(error);
                }
            });

            //
            // VERSION
            //
//            let language_prefix = translated_interaction_labels['menu']['language']['language_prefix'];
//            selectedLanguage = language_dict[user_data['language_code']];
            $('#version-menu .main-menu-text' ).text("Version" + ": " + version);
        });

    </script>
</head>

<body>

    <div id="dialog-warning-update-failed" title="Failure" style="display:none">
        <div class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></div><p></p>
    </div>
    <div id="dialog-success-update-success" title="Success" style="display:none">
        <div class="ui-icon ui-icon-check" style="float:left; margin:12px 12px 20px 0;"></div><p></p>
    </div>
    <!-- Continue interrupted video Dialog window -->
    <div id="dialog-confirm-continue-interrupted-play" title="continue_interrupted_playback" style="display:none">
        <div class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></div>
        <p></p>
    </div>

    <!-- Login input modal window -->
    <div id="dialog-form-login" title="login" style="display:none">
        <p>qewrqew</p>
        <form method="POST">
            <fieldset>
              <label for="username">Name</label>
              <input type="text" name="name" id="username" value="" autocomplete="off" class="text ui-widget-content ui-corner-all">
              <label for="password">Password</label>
              <input type="password" name="password" autocomplete="off" id="password" value="" class="text ui-widget-content ui-corner-all">

              <!-- Allow form submission with keyboard without duplicating the dialog button -->
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>

    <!-- Search form modal window -->


    <div id="dialog-form-search" title="Search Media" style="display:none">
        <fieldset>
            <table>
                <tr>
                    <td><label for="dialog-search-container-title">Title: </label></td>
                    <td><input type="text" name="dialog-search-container-title" id="dialog-search-container-title" class="text ui-widget-content ui-corner-all"></td>
                </tr>
                    <tr><td colspan="2"><div class="dialog-search-separator"></div></td>
                </tr>




                <!-- Genre -->
                <tr>
                    <td><label for="dialog-search-genre">Genre: </label></td>
                    <td><input type="text" name="dialog-search-genre" id="dialog-search-genre" class="text ui-widget-content ui-corner-all" /></td>
                    <!-- <td><select name="dialog-search-genre" id="dialog-search-genre" class="ui-widget-content ui-corner-all" /></td> -->
                </tr>

                <!-- Theme -->
                <tr>
                    <td><label for="dialog-search-theme">Theme: </label></td>
                    <td><input type="text" name="dialog-search-theme" id="dialog-search-theme" class="text ui-widget-content ui-corner-all" /></td>
                    <!-- <td><select name="dialog-search-theme" id="dialog-search-theme" class="ui-widget-content ui-corner-all"/></td> -->
                </tr>

                <!-- Director -->
                <tr>
                    <td><label for="dialog-search-director">Directors: </label></td>
                    <td><input type="text" name="dialog-search-director" id="dialog-search-director" class="text ui-widget-content ui-corner-all"></td>
                </tr>

                <!-- Writer -->
                <tr>
                    <td><label for="dialog-search-writer">Writers: </label></td>
                    <td><input type="text" name="dialog-search-writer" id="dialog-search-writer" class="text ui-widget-content ui-corner-all"></td>
                </tr>

                <!-- Actor -->
                <tr>
                    <td><label for="dialog-search-actor">Actors: </label></td>
                    <td><input type="text" name="dialog-search-actor" id="dialog-search-actor" class="text ui-widget-content ui-corner-all"></td>
                </tr>

                <!-- Voice -->
                <tr>
                    <td><label for="dialog-search-voice">Voices: </label></td>
                    <td><input type="text" name="dialog-search-voice" id="dialog-search-voice" class="text ui-widget-content ui-corner-all"></td>
                </tr>

                <!-- Origin -->
                <tr>
                    <td><label for="dialog-search-origin">Origins: </label></td>
                    <td><input type="text" name="dialog-search-origin" id="dialog-search-origin" class="text ui-widget-content ui-corner-all"></td>
                </tr>

                <!-- Tag -->
                <tr>
                    <td><label for="dialog-search-tag">Tag: </label></td>
                    <td><input type="text" name="dialog-search-tag" id="dialog-search-tag" class="text ui-widget-content ui-corner-all"></td>
                </tr>

                <!-- Show Level -->
                <tr>
                    <td><label for="dialog-search-show-level">View State: </label></td>
                    <td>
                        <select name="dialog-search-show-level" id="dialog-search-show-level" class="ui-widget-content ui-corner-all">
                            <option value="/collect/highest/mixed">Highest</option>
                            <option value="/collect/lowest">Lowest</option>
                        </select>
                    </td>
                </tr>

                <!-- View State -->
                <tr>
                    <td><label for="dialog-search-view-state">View State: </label></td>
                    <td>
                        <select name="dialog-search-view-state" id="dialog-search-view-state" class="ui-widget-content ui-corner-all">
                            <option value=""></option>
                            <option value="interrupted"></option>
                            <option value="last_watched"></option>
                            <option value="most_watched"></option>
                        </select>
                    </td>
                </tr>

                <!-- Rate -->
                <tr>
                    <td><label for="dialog-search-rate">Rate: </label></td>
                    <td>
                        <select name="dialog-search-rate" id="dialog-search-rate" class="ui-widget-content ui-corner-all">
                            <option value=""></option>
                            <option value="1">★</option>
                            <option value="2">★★</option>
                            <option value="3">★★★</option>
                            <option value="4">★★★★</option>
                            <option value="5">★★★★★</option>
                        </select>
                    </td>
                </tr>
            </table>
        </fieldset>

        <div id="dropdowns"></div>
    </div>






    <div id="menu-line">
        <div id="logo-container">
            <img src="images/product-image/homeflix-image.png" alt="Logo" id="menu-logo">
        </div>

        <div id="setting-menu" class="main-menu admin">
            <div class="main-menu-text">Server Settings</div>
            <ul id="setting-dropdown" class="dropdown">
                <li class="option setting" value="rebuild-static-db">Re-build Static DB</li>
                <li class="option setting" value="rebuild-personal-db">Re-build Personal DB</li>
                <li class="option setting" value="update-sw">Update SW</li>
            </ul>
        </div>
        <div id="language-menu" class="main-menu user">
            <div class="main-menu-text">Language: English</div>
            <ul id="language-dropdown" class="dropdown">
                <li class="option language" value="en">English</li>
                <li class="option language" value="hu">Magyar </li>
            </ul>
        </div>
        <div id="personal-menu" class="main-menu user">
            <div class="main-menu-text">No one</div>
            <ul id="personal-dropdown" class="dropdown">
                <li class="option personal" value="login">Login</li>
                <li class="option personal" value="logout">Logout</li>
            </ul>
        </div>
        <div id="version-menu" class="main-menu user">
            <div class="main-menu-text">Version:</div>
        </div>

<!--
        <div class="main-menu empty">
            <div class="main-menu-text">&nbsp; &nbsp; &nbsp; </div>
        </div>
-->

    </div>

    <div id="viewport">

        <!-- Info section -->
        <div id="static-section">
            <div id="description-section">
                <div id="description-text-div">
                    <div id="description-text-wrapper">

                        <div id="description-text-title"></div>
                        <div id="description-text-container-outer">
                            <div id="description-text-container">
                                <div id="description-text-extra">
                                    <div id="description-text-extra-date"></div>
                                    <div id="description-text-extra-length"></div>
                                    <div id="description-text-extra-block">
                                        <div id="description-text-extra-block-origin"></div>
                                        <div id="description-text-extra-block-genre"></div>
                                        <div id="description-text-extra-block-theme"></div>
                                    </div>
                                </div>

                                <div id="description-text-area-div">
                                    <div id="description-text-storyline" class="with-scrollbar"></div>
                                </div>
                            </div>
                            <div id="description-text-credentials" class="with-scrollbar"></div>
                        </div>
                        <div id="description-appendix">
                            <div id="description-appendix-download"></div>
                            <div id="description-appendix-play"></div>
                        </div>

                        <div id="description-tagging"></div>
                        <div id="description-rating"></div>

                    </div>
                </div>
                <div id="description-image">
                </div>
            </div>
            <div id="container-control-section">
                <div id="history-section">
                    <div id="history-section-text"></div>
                    <div id="history-section-link"></div>
                </div>
                <div id="container-controllers">
                    <!-- ➕ -->
                    <div id="container-controllers-add">&#10133;</div>
                    <div id="container-controllers-up-down">
                        <img src="images/tools/arrow-mobile-up.png" alt="Up/Down Navigation">
                        <img src="images/tools/arrow-mobile-down.png" alt="Down Navigation">
                    </div>
                </div>
            </div>
        </div>

        <!-- scroll section ➕ -->
        <div>
            <div id="scroll-section">
            </div>
        </div>

        <!-- spinner -->
        <div id="spinner">
            <img src="spinner.gif">
        </div>
    </div>

    <!-- Video container -->
    <div id="video-container">
        <video height="0" id="video_player"></video>
    </div>
    <div>
        <div id="overlay"></div>
        <div id="modal">
            <div id="close-button">❌</div>
            <pre><code id="text-content"></code></pre>
        </div>
    </div>

</body>
</html>