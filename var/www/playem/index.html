<meta charset="UTF-8" comntent="text/html;charset=utf-8" http-equiv="Content-Type">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">

<html>
<head>

    <title>Playem</title>

    <style>

        :root {
            --thumbnail-width: 300px;
            --container-height: 250px;
            --selector-border-width: 6px; 
            --tmp-border-width: 10px;
        }

        #detail-screen{
            /*height: 600px;*/
            height: 60%;
            width: 100%;
            background-color: gray;
            border: var(--tmp-border-width) green solid;
            box-sizing:border-box;
        }

        #detail-image{
            height: 100%;
        }

        #detail-title{
            position: absolute;
            top:10px;
            right: 80px;
            text-shadow: 
                0px 0px 20px black;

            font-family: cursive;
            font-weight: bold;
            font-size: 70px;
            color: white;
        }

        .thumbnail-section {
            height: 40%;
            display: flex;
            flex-wrap: nowrap;
            flex-direction: column;
            overflow: hidden; 
            border:var(--tmp-border-width) red solid;
            width: 100%;
            box-sizing:border-box;
        }

        .thumbnail-container {
            width: 100%;
            height: var(--container-height);
            min-height: var(--container-height);
            overflow: hidden; 
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: flex-start;
            border:var(--tmp-border-width) blue solid;
            box-sizing:border-box;
        }

        .thumbnail {
        /*    width: var(--width); */
            height: 100%; /*var(--height);*/
            margin: 0px;
            border: var(--selector-border-width) solid transparent;
            background-color: black;
  
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing:border-box;
        }

        .thumbnail img {
            width: var(--thumbnail-width);
            height: auto;
            /*max-height: var(--height);  */
        }        

#left-arrow,
#right-arrow {
  cursor: pointer;
  font-size: 24px;
  margin-top: 5px;
}

#left-arrow {
  margin-right: 10px;
}
    </style>
    
    <!-- JQuery -->
    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/jquery-ui/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="script/jquery-ui/jquery-ui.css">

    <script>

    const thumbnail_width = 300;
    const container_height = 250;
    const selector_border_width = 6;
    const tmp_border_width = 10;

    var t = document.querySelector(':root');
    t.style.setProperty('--thumbnail-width', thumbnail_width+'px');
    t.style.setProperty('--container-height', container_height + 'px');
    t.style.setProperty('--selector-border-width', selector_border_width + 'px'); 
    t.style.setProperty('--tmp-border-width', tmp_border_width + 'px');
//    t.style.setProperty('--height', '250px');

    $('#right-arrow').click(function() {
        thumbnails.eq(currentIndex).css('border-color', 'transparent');
        currentIndex = (currentIndex + 1) % thumbnails.length;
        thumbnails.eq(currentIndex).css('border-color', 'white');
        scrollThumbnails();
    });

    $('#left-arrow').click(function() {
        thumbnails.eq(currentIndex).css('border-color', 'transparent');
        currentIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
        thumbnails.eq(currentIndex).css('border-color', 'white');
        scrollThumbnails();
    });

    /*
    Substitute substrings, similar to "Hello {0}".format("world") mechanizm
    Usage: "hello {}".format("world")
    */ 
    String.prototype.format = function () {
        var i = 0, args = arguments;
        return this.replace(/{}/g, function () {
            return typeof args[i] != 'undefined' ? args[i++] : '';
        });
    };

    var attributeMap =
    {
        "section-class": "thumbnail-section",
        "container-class": "thumbnail-container",
        "thumbnail-class": "thumbnail",
        "section-id"     : "section-{}",
        "container-id": "section-{}_container-{}",
        "thumbnail-id": "section-{}_container-{}_thumbnail-{}",
    }

    var sectionsMap = 
    {
        "current-section-index": 0,
        "sections": []
    }

    // var sectionsMap = 
    // {
    //     "current-section-index": 0,
    //     "sections": [
    //         {
    //             "section-id": "section-0",
    //             "current-container-index": 0,
    //             "containers": [
    //                 {                    
    //                     "container-id": "section-0_container-0",
    //                     "current-thumbnail-index": 0,
    //                     "thumbnails": [
    //                          {
    //                              "thumbnail-id": "section-0_container-0_thumbnail-0"
    //                          }
    //                     ]
    //                 },
    //             ]
    //         }
    //     ]
    // }

    $(document).on('keydown',function(e){
            var act={37:go_left, 38:go_up, 39:go_right, 40:go_down};

            //console.log(e.which)

            if(act[e.which]) 
                var a=new act[e.which];
    });

    function getIndexesByThumbnailId(thumbnailId){

        // Searching elements in the DOM makes a little bit faster than go through in the sectionMap
        thumbnail = $("#" + nextThumbnailId);        
        container = thumbnail.closest('div.' + attributeMap["container-class"]).eq(0);
        containerId = container.attr('id');
        section = container.closest('div.' + attributeMap["section-class"]).eq(0);
        sectionId = section.attr('id');

        // And now I go back to the sectionMap
        for (sectionIndex=0; sectionIndex < sectionsMap['sections'].length; sectionIndex++){
            if(sectionsMap['sections'][sectionIndex]['section-id'] == sectionId){
                break;
            }
        }

        for (containerIndex=0; containerIndex < sectionsMap['sections'][sectionIndex]['containers'].length; containerIndex++){
            if(sectionsMap['sections'][sectionIndex]['containers'][containerIndex]['container-id'] == containerId){
                break;
            }
        }

        for (thumbnailIndex=0; thumbnailIndex < sectionsMap['sections'][sectionIndex]['containers'][containerIndex]['thumbnails'].length; thumbnailIndex++){
            if(sectionsMap['sections'][sectionIndex]['containers'][containerIndex]['thumbnails'][thumbnailIndex]['thumbnail-id'] == thumbnailId){
                break;
            }
        }
        return {
            sectionIndex: sectionIndex,
            containerIndex: containerIndex,
            thumbnailIndex: thumbnailIndex
        }
    }
   
    // function getIndexesByThumbnailId(thumbnailId){

    //     mygetIndexesByThumbnailId(thumbnailId);
    //     var found = false;
    //     var sectionIndex=0;
    //     var containerIndex=0;
    //     var thumbnailIndex=0;

    //     for (sectionIndex=0; sectionIndex < sectionsMap["sections"].length; sectionIndex++){
            
    //         containerList = sectionsMap["sections"][sectionIndex]["containers"];
    //         for(containerIndex=0; containerIndex < containerList.length; containerIndex++){

    //             thumbnailList = sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"];
    //             for(thumbnailIndex=0; thumbnailIndex < thumbnailList.length; thumbnailIndex++){

    //                 if (sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"][thumbnailIndex]["thumbnail-id"] == thumbnailId){
    //                     found = true;
    //                     break;
    //                 }
    //             }
    //             if(found){break;}
    //         }
    //         if(found){break;}
    //     }

    //     return {
    //         sectionIndex: sectionIndex,
    //         containerIndex: containerIndex,
    //         thumbnailIndex: thumbnailIndex
    //     }
    // }

    /*
    Remove the old selection border
    Show the new selection border
    */
    function selectThumbnail(nextThumbnail){

        // First remove the previous selection wherever it is
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        currentThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"];
        
        thumbnailList = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["thumbnails"];
        currentThumbnailId = thumbnailList[currentThumbnailIndex]["thumbnail-id"];
        currentThumbnail = $("#" + currentThumbnailId);
        currentThumbnail.css('border-color', 'transparent');

        // Select the new thumbnail
        nextThumbnailId = nextThumbnail.attr('id');
        nextThumbnail = $("#" + nextThumbnailId);
        nextThumbnail.css('border-color', 'white');

        // Identify the new section/container/thumbnail and set them as current-
        indexes = getIndexesByThumbnailId(nextThumbnailId);
        nextSectionIndex = indexes["sectionIndex"];
        nextContainerIndex = indexes["containerIndex"];
        nextThumbnailIndex = indexes["thumbnailIndex"];

        sectionsMap["current-section-index"] = nextSectionIndex
        sectionsMap["sections"][nextSectionIndex]["current-container-index"] = nextContainerIndex
        sectionsMap["sections"][nextSectionIndex]["containers"][ nextContainerIndex]["current-thumbnail-index"] = nextThumbnailIndex

        scrollThumbnails(nextSectionIndex, nextContainerIndex, nextThumbnailIndex);
    }

    function scrollThumbnails(sectionIndex, containerIndex, thumbnailIndex) {

        thumbnailId = sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"][thumbnailIndex]["thumbnail-id"];
        thumbnail = $("#" + thumbnailId);
        thumbnailWidth = thumbnail.outerWidth(true);

        containerId = sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["container-id"]           
        container = $("#" + containerId);
        containerWidth = container.width();
        containerScrollLeft = container.scrollLeft();

        var visibleThumbnails = Math.floor(containerWidth / thumbnailWidth);

        if (thumbnailIndex >= visibleThumbnails + containerScrollLeft / thumbnailWidth) {
            container.animate({ scrollLeft: thumbnailWidth * (thumbnailIndex - visibleThumbnails + 1) }, 200);
        } else if (thumbnailIndex < containerScrollLeft / thumbnailWidth) {
            container.animate({ scrollLeft: thumbnailWidth * thumbnailIndex }, 200);
        }
        
        showDetails(thumbnail);
    }

    /*
    Rotates to right the the selection on the thumbnails
    It stays in the same container
    */
    function go_right(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        currentThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"];
        
        thumbnailList = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["thumbnails"];
        currentThumbnailId = thumbnailList[currentThumbnailIndex]["thumbnail-id"];
        currentThumbnail = $("#" + currentThumbnailId);
        currentThumbnail.css('border-color', 'transparent');
        nextThumbnailIndex = (currentThumbnailIndex + 1) % thumbnailList.length;
        nextThumbnailId = thumbnailList[nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        nextThumbnail.css('border-color', 'white');
        sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"] = nextThumbnailIndex

        scrollThumbnails(currentSectionIndex, currentContainerIndex, nextThumbnailIndex);
    }

    /*
    Rotates to right the the selection on the thumbnails
    It stays in the same container
    */
    function go_left(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        currentThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"];
        
        thumbnailList = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["thumbnails"];
        currentThumbnailId = thumbnailList[currentThumbnailIndex]["thumbnail-id"];
        currentThumbnail = $("#" + currentThumbnailId);
        currentThumbnail.css('border-color', 'transparent');
        
        nextThumbnailIndex = (currentThumbnailIndex - 1 + thumbnailList.length) % thumbnailList.length;
        nextThumbnailId = thumbnailList[nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        nextThumbnail.css('border-color', 'white');
        sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"] = nextThumbnailIndex

        scrollThumbnails(currentSectionIndex, currentContainerIndex, nextThumbnailIndex);
    }

    /*
    Rotates the selection on the thumbnails to up to the previous container in the same section
    */
    function go_up(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        containerList = sectionsMap["sections"][currentSectionIndex]["containers"];
        
        nextContainerIndex = (currentContainerIndex - 1 + containerList.length) % containerList.length;
        nextThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["current-thumbnail-index"];
        nextThumbnailId = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["thumbnails"][nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        selectThumbnail(nextThumbnail);
    }

    /*
    Rotates the selection on the thumbnails to up to the previous container in the same section
    */
    function go_down(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        containerList = sectionsMap["sections"][currentSectionIndex]["containers"];
        nextContainerIndex = (currentContainerIndex + 1) % containerList.length;
        nextThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["current-thumbnail-index"];
        nextThumbnailId = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["thumbnails"][nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        selectThumbnail(nextThumbnail);
    }

    function showDetails(thumbnail){
        //$('#detail-screen').html("");        
        src = thumbnail.children('img').attr('src')
        title = thumbnail.children('img').attr('title')
        title_orig = thumbnail.children('img').attr('title_orig')
        lang_orig = thumbnail.children('img').attr('lang_orig')
        
        $('#detail-image').attr("src", src);
        
        if(title){
            $('#detail-title').text(title);
        }else{
            $('#detail-title').text(title_orig);            
        }
        
        // src: source_path + '/image.jpg',
        //                 alt: "Image 1",
        //                 title: title,
        //                 title_orig: title_orig,
        //                 lang_orig: lang_orig,
        //                 card_id: card_id,
        //                 source_path: source_path,
    }


    /*
    type:
    url:
    sectionIndex:
    sectionsMap:
    thumbnailSection:
    */
    function createNewContainer(param){
     
        function selectDefaultThumbnail(sectionsMap){
                defaultThumbnailContainerId = sectionsMap["sections"][sectionIndex]["containers"][defaultCurrentContainerIndex]["container-id"];
                thumbnailClass = attributeMap["thumbnail-class"];
                defaultThumbnails = $("#" + defaultThumbnailContainerId + " ." + thumbnailClass);
                defaultThumbnail = defaultThumbnails.eq(defaultCurrentThumbnailIndex);
                selectThumbnail(defaultThumbnail);
        }

        function addNewContainerToSection(sectionsMap, sectionIndex){
        
           // Add an empty thumbnail-container to the container list
            newLength = sectionsMap["sections"][sectionIndex]["containers"].push({});
            containerIndex = newLength - 1;

            // Create thumbnail-container object
            thumbnailContainer = $('<div>', {
                class: attributeMap["container-class"],
                id: attributeMap["container-id"].format(sectionIndex, containerIndex)
            })
            sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["container-id"] = thumbnailContainer.attr('id');
            sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["current-thumbnail-index"] = 0;
            sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"] = [];

            return {containerIndex: containerIndex, thumbnailContainer: thumbnailContainer}
        }

        sectionsMap = param["sectionsMap"];
        sectionIndex = param["sectionIndex"];
        section = param["section"];
     
        $.ajax({type: param["type"], url: param["url"], async: true,
            success: function(result){

                text = "";
                
                // Add empty container to the container list and create and return thumbnail-container object
                ret = addNewContainerToSection(sectionsMap, sectionIndex);
                containerIndex = ret["containerIndex"];
                thumbnailContainer = ret["thumbnailContainer"];

                for (i in result) {
                    record=result[i];

                    card_id = record["id"];
                    source_path = record["source_path"];
                    
                    title = "";
                    title_orig = "";
                    lang_orig = "";
                    if ( record["title_req"] != null ){
                        title = record["title_req"];
                    }
                    if ( record["title_orig"] != null ){
                        title_orig = record["title_orig"];
                        lang_orig = record["lang_orig"];
                    }

                    // Add an empty thumbnail to the thumbnail list
                    newLength = sectionsMap["sections"][sectionIndex]["containers"][containerIndex]['thumbnails'].push({});
                    thumbnailIndex = newLength - 1;
   
                    // Create thumbnail
                    thumbnail = $("<div>", {
                        class: attributeMap["thumbnail-class"],
                        id: attributeMap["thumbnail-id"].format(sectionIndex, containerIndex, thumbnailIndex)
                    });

                    sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"][thumbnailIndex]["thumbnail-id"] = thumbnail.attr('id');
//                    sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"][thumbnailIndex]["title"] = title;
//                    sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"][thumbnailIndex]["title"] = title;

                    // Create image
                    image = $("<img>",{
                        src: source_path + '/image.jpg',
                        alt: "Image 1",
                        title: title,
                        title_orig: title_orig,
                        lang_orig: lang_orig,
                        card_id: card_id,
                        source_path: source_path,
                    });
                    thumbnail.append(image);                 

                    // mouse event for thumbnail
                    thumbnail.click(function(){
                        selectThumbnail($(this))
                    });

                    // Place thumbnail into thumbnail-container
                    thumbnailContainer.append(thumbnail);

                    // width = image.prop('naturalWidth');
                    // height = image.prop('naturalHeight');
                    // if (height > width){
                    //     ratio = width/height;
                    //     thumbailWidth = parseInt(height * ratio)
                    // }else{
                    //     thumbleWidth = thumbnail_width
                    // }
                    // t.style.setProperty('----thumbnail-width', thumbnail_width + 'px');
                }               

                //
                section.append($("<div>", {height: "30px"}).text("hello"));


                // Place thumbnail Container into thumbnail-section
                section.append(thumbnailContainer);

                // selection border for the default first thumbnail - it is possible as at least one section container is done
                selectDefaultThumbnail(param["sectionsMap"]);
            },
            error: function(xhr,status,error){
                $("#message").html("");
                $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
//              $("#spinner").hide();
            }
        })
    }

    var defaultCurrentSectionIndex = 0;
    var defaultCurrentContainerIndex = 0;
    var defaultCurrentThumbnailIndex = 0;

    var languageCode = 'hu';

    // ================================================
    // ================================================
    //
    //  When the page is loaded
    //
    // ================================================
    // ================================================
    $(document).ready(function(){

        // Create a new thumbnail-section
        sectionLength = sectionsMap["sections"].push({});
        sectionIndex0 = sectionLength - 1;
        sectionsMap["current-section-index"] = sectionIndex0;

        thumbnailSection_0 = $('<div>', {
            id: attributeMap["section-id"].format(sectionIndex0),
            class: attributeMap["section-class"],
        })

        sectionsMap["sections"][sectionIndex0]["section-id"] = thumbnailSection_0.attr('id');
        sectionsMap["sections"][sectionIndex0]["containers"] = [];
        sectionsMap["sections"][sectionIndex0]["current-container-index"] = 0;

        // Place thumbnail-section into the thumbnail section
        $('#thumbnail-sections').append(thumbnailSection_0);

        // Drama container
        createNewContainer({
            type: "GET",
            url: "/collect/standalone/movies/genre/drama/lang/" + languageCode,
            section: thumbnailSection_0,
            sectionIndex: sectionIndex0,
            sectionsMap: sectionsMap,
        });
        
        // Action container
        createNewContainer({
            type: "GET",
            url: "/collect/standalone/movies/genre/action/lang/" + languageCode,
            section: thumbnailSection_0,
            sectionIndex: sectionIndex0,
            sectionsMap: sectionsMap,
        });
  

// ---

    })

    </script>

</head>
<body style="background-color:DarkGrey;">

    <div id="detail-screen">
        <img id="detail-image"/>
        <div id="detail-title"></div>
    </div>


    <div id="thumbnail-sections"></div>

    <div id="message"></div>
    <div id="errormessage"></div>
</body>
</html>