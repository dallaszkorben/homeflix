<meta charset="UTF-8" comntent="text/html;charset=utf-8" http-equiv="Content-Type">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">

<html>
<head>

    <title>Playem</title>

    <style>

        :root {
            --container-height: 250px;
            --selector-border-width: 6px; 
            --tmp-border-width: 10px;
            --background-image: "";
        }

        body {
            margin: 0px;
        }

        #detail-screen{
            height: 50%;
            width: 100%;

            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;

            background-color: rgb(255, 255, 255);
            border: var(--tmp-border-width) green solid;
            box-sizing:border-box;            
        }

        #detail-text-div{
            height: 100%;
            width: 50%;
            display:inline;
            font-family: 'Brush Script MT', cursive;
            background: linear-gradient(to left, rgb(255, 255, 255) 0%,rgb(9, 60, 41) 60%);
        }

        #detail-text-title{
            position: relative;
            top:10px;
            left: 10px;
            text-shadow: 
                0px 0px 20px black;
            font-weight: bold;
            font-size: 70px;
            color: white;
        }

        #detail-image-div{
            height: 100%;
            width: 50%;

            background: var(--background-image);
            box-shadow: inset 100px -100px 40px 0 #FFF;
            background-position: right top;
            background-repeat: no-repeat;
            background-size: contain;
        }

        .thumbnail-section {
            height: 40%;
            display: flex;
            flex-wrap: nowrap;
            flex-direction: column;
            overflow: hidden; 
            border:var(--tmp-border-width) red solid;
            width: 100%;
            box-sizing:border-box;

            background-color: rgb(77, 77, 77);
        }

        .thumbnail-container-title{
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 30px;
            color: black;
        }

        .thumbnail-container {
            width: 100%;
            height: var(--container-height); 
            min-height: var(--container-height); 

            overflow: hidden; 
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: flex-start;
            border:var(--tmp-border-width) blue solid;
            box-sizing:border-box;

            background-color: rgb(77, 77, 77);
        }

        .thumbnail {
            height: 100%;         
            margin: 0px;
            border: var(--selector-border-width) solid transparent;
            background-color: black;
  
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing:border-box;
            position: relative;              /* This made the animation with text work. I do not know how */
        }

        .thumbnail img {
            width: var(--image-width);
            height: var(--image-height);
            max-height: var(--image-height);
            object-fit: contain;
        }
        
        .thumbnail-text-wrapper{            
            position: absolute;              /* Needed for overlap text the image */
            max-width: var(--image-width);   /* Needed to teach absolute div what is the size*/

            width: var(--image-width);
            height: var(--image-height);
            max-height: var(--image-height);


            font-family: 'Brush Script MT', cursive;
            font-weight: bold;
            font-size: 70px;
            color: rgb(110, 176, 172);
            text-shadow: 
                -1px -1px 0px black,
                1px -1px 0px black,
                1px 1px 0px black,
                -1px 1px 0px black;
        }

        .thumbnail-text{
            position: relative;              /* Needed to wrap log text */
            text-align: center;              /* Needed to centralized the wrapped text */
        }        

        #history-container{
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;

            font-family: Arial, sans-serif;
            font-weight: normal;
            font-size: 30px;
            cursor:grab;
            min-height: 30px; 
            max-height: 30px;
        }

        .link{
        }
        .link:hover {
            text-decoration: underline;
            color: rgb(0, 9, 129);
        }

    </style>
    
    <!-- JQuery -->
    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/jquery-ui/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="script/jquery-ui/jquery-ui.css">

    <script>

    const selector_border_width = 4;
    const tmp_border_width = 1;
    const image_height = 250;
    const image_width = 300;
    const container_height = image_height + (2*selector_border_width) + (2*tmp_border_width);

    var t = document.querySelector(':root');

    t.style.setProperty('--container-height', container_height + 'px');
    t.style.setProperty('--selector-border-width', selector_border_width + 'px'); 
    t.style.setProperty('--image-height', image_height + 'px');
    t.style.setProperty('--image-width', image_width + 'px');
    t.style.setProperty('--tmp-border-width', tmp_border_width + 'px');

    $('#right-arrow').click(function() {
        thumbnails.eq(currentIndex).css('border-color', 'transparent');
        currentIndex = (currentIndex + 1) % thumbnails.length;
        thumbnails.eq(currentIndex).css('border-color', 'white');
        scrollThumbnails();
    });

    $('#left-arrow').click(function() {
        thumbnails.eq(currentIndex).css('border-color', 'transparent');
        currentIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
        thumbnails.eq(currentIndex).css('border-color', 'white');
        scrollThumbnails();
    });

    /*
    Substitute substrings, similar to "Hello {0}".format("world") mechanizm
    Usage: "hello {}".format("world")
    */ 
    String.prototype.format = function () {
        var i = 0, args = arguments;
        return this.replace(/{}/g, function () {
            return typeof args[i] != 'undefined' ? args[i++] : '';
        });
    };

    var attributeMap =
    {
        "section-class": "thumbnail-section",
        "container-class": "thumbnail-container",
        "thumbnail-class": "thumbnail",
        "thumbnail-text-wrapper-class": "thumbnail-text-wrapper",
        "thumbnail-text-class": "thumbnail-text",

        "section-id"     : "section-{}",
        "container-id": "section-{}_container-{}",
        "thumbnail-id": "section-{}_container-{}_thumbnail-{}",
    }

    var sectionsMap = 
    {
        "current-section-index": 0,
        "sections": []
    }

    // var sectionsMap = 
    // {
    //     "current-section-index": 0,
    //     "sections": [
    //         {
    //             "section-id": "section-0",
    //             "current-container-index": 0,
    //             "containers": {
    //                 "0": {                    
    //                     "container-id": "section-0_container-0",
    //                     "current-thumbnail-index": 0,
    //                     "thumbnails": [
    //                          {
    //                              "thumbnail-id": "section-0_container-0_thumbnail-0"
    //                          }
    //                     ]
    //                 },
    //             }
    //         }
    //     ]
    // }

    let containerFocusEvent = new Event("hello", {bubbles: true});

    $(document).on('keydown',function(e){
            var act={37:go_left, 38:go_up, 39:go_right, 40:go_down};

            //console.log(e.which)

            if(act[e.which]) 
                var a=new act[e.which];
    });

    function getIndexesByThumbnailId(thumbnailId){

        // Searching elements in the DOM makes a little bit faster than go through in the sectionMap
        thumbnail = $("#" + nextThumbnailId);        
        container = thumbnail.closest('div.' + attributeMap["container-class"]).eq(0);
        containerId = container.attr('id');
        section = container.closest('div.' + attributeMap["section-class"]).eq(0);
        sectionId = section.attr('id');

        // And now I go back to the sectionMap
        for (sectionIndex=0; sectionIndex < sectionsMap['sections'].length; sectionIndex++){
            if(sectionsMap['sections'][sectionIndex]['section-id'] == sectionId){
                break;
            }
        }

        for (containerIndex=0; containerIndex < sectionsMap['sections'][sectionIndex]['containers'].length; containerIndex++){
            if(sectionsMap['sections'][sectionIndex]['containers'][containerIndex]['container-id'] == containerId){
                break;
            }
        }

        for (thumbnailIndex=0; thumbnailIndex < sectionsMap['sections'][sectionIndex]['containers'][containerIndex]['thumbnails'].length; thumbnailIndex++){
            if(sectionsMap['sections'][sectionIndex]['containers'][containerIndex]['thumbnails'][thumbnailIndex]['thumbnail-id'] == thumbnailId){
                break;
            }
        }
        return {
            sectionIndex: sectionIndex,
            containerIndex: containerIndex,
            thumbnailIndex: thumbnailIndex
        }
    }
   
    /*
    Remove the old selection border
    Show the new selection border
    */
    function selectThumbnail(nextThumbnail){

        // First remove the previous selection wherever it is
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        currentThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"];
        
        thumbnailList = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["thumbnails"];
        currentThumbnailId = thumbnailList[currentThumbnailIndex]["thumbnail-id"];
        currentThumbnail = $("#" + currentThumbnailId);
        currentThumbnail.css('border-color', 'transparent');

        // Select the new thumbnail
        nextThumbnailId = nextThumbnail.attr('id');
        nextThumbnail = $("#" + nextThumbnailId);
        nextThumbnail.css('border-color', 'white');

        // Identify the new section/container/thumbnail and set them as current-
        indexes = getIndexesByThumbnailId(nextThumbnailId);
        nextSectionIndex = indexes["sectionIndex"];
        nextContainerIndex = indexes["containerIndex"];
        nextThumbnailIndex = indexes["thumbnailIndex"];

        sectionsMap["current-section-index"] = nextSectionIndex
        sectionsMap["sections"][nextSectionIndex]["current-container-index"] = nextContainerIndex
        sectionsMap["sections"][nextSectionIndex]["containers"][ nextContainerIndex]["current-thumbnail-index"] = nextThumbnailIndex

        scrollThumbnails(nextSectionIndex, nextContainerIndex, nextThumbnailIndex);
    }

    function scrollThumbnails(sectionIndex, containerIndex, thumbnailIndex) {

        // Vertical adjustment
        containerId = sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["container-id"]           
        container = $("#" + containerId);

        containerHeight = container.outerHeight(true);

        sectionId = sectionsMap["sections"][sectionIndex]["section-id"]
        section = $("#" + sectionId);
        sectionHeight = section.outerHeight(true);

        sectionHeight = section.height();
        sectionScrollTop = section.scrollTop();        
        
        visibleContainers = Math.floor(sectionHeight / containerHeight);

        if (containerIndex >= visibleContainers + sectionScrollTop / containerHeight) {
            section.animate({ scrollTop: containerHeight * (containerIndex - visibleContainers + 1) }, 200);
        } else if (containerIndex < sectionScrollTop / containerHeight) {
            section.animate({ scrollTop: containerHeight * containerIndex }, 200);
        }

        // Horizontal adjustment
        thumbnailId = sectionsMap["sections"][sectionIndex]["containers"][containerIndex]["thumbnails"][thumbnailIndex]["thumbnail-id"];
        thumbnail = $("#" + thumbnailId);
        thumbnailWidth = thumbnail.outerWidth(true);

        containerWidth = container.width();
        containerScrollLeft = container.scrollLeft();        

        var visibleThumbnails = Math.floor(containerWidth / thumbnailWidth);

        if (thumbnailIndex >= visibleThumbnails + containerScrollLeft / thumbnailWidth) {
            container.animate({ scrollLeft: thumbnailWidth * (thumbnailIndex - visibleThumbnails + 1) }, 200);
        } else if (thumbnailIndex < containerScrollLeft / thumbnailWidth) {
            container.animate({ scrollLeft: thumbnailWidth * thumbnailIndex }, 200);
        }
        
        thumbnail.trigger("containerFocusEvent");
    }

    /*
    Rotates to right the the selection on the thumbnails
    It stays in the same container
    */
    function go_right(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        currentThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"];
        
        thumbnailList = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["thumbnails"];
        currentThumbnailId = thumbnailList[currentThumbnailIndex]["thumbnail-id"];
        currentThumbnail = $("#" + currentThumbnailId);
        currentThumbnail.css('border-color', 'transparent');
        nextThumbnailIndex = (currentThumbnailIndex + 1) % thumbnailList.length;
        nextThumbnailId = thumbnailList[nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        nextThumbnail.css('border-color', 'white');
        sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"] = nextThumbnailIndex

        scrollThumbnails(currentSectionIndex, currentContainerIndex, nextThumbnailIndex);
    }

    /*
    Rotates to right the the selection on the thumbnails
    It stays in the same container
    */
    function go_left(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        currentThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"];
        
        thumbnailList = sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["thumbnails"];
        currentThumbnailId = thumbnailList[currentThumbnailIndex]["thumbnail-id"];
        currentThumbnail = $("#" + currentThumbnailId);
        currentThumbnail.css('border-color', 'transparent');
        
        nextThumbnailIndex = (currentThumbnailIndex - 1 + thumbnailList.length) % thumbnailList.length;
        nextThumbnailId = thumbnailList[nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        nextThumbnail.css('border-color', 'white');
        sectionsMap["sections"][currentSectionIndex]["containers"][currentContainerIndex]["current-thumbnail-index"] = nextThumbnailIndex

        scrollThumbnails(currentSectionIndex, currentContainerIndex, nextThumbnailIndex);
    }

    /*
    Rotates the selection on the thumbnails to up to the previous container in the same section
    */
    function go_up(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        containerList = sectionsMap["sections"][currentSectionIndex]["containers"];
        
        nextContainerIndex = (currentContainerIndex - 1 + containerList.length) % containerList.length;
        nextThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["current-thumbnail-index"];
        nextThumbnailId = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["thumbnails"][nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        selectThumbnail(nextThumbnail);
    }

    /*
    Rotates the selection on the thumbnails to up to the previous container in the same section
    */
    function go_down(){
        currentSectionIndex = sectionsMap["current-section-index"];
        currentContainerIndex = sectionsMap["sections"][currentSectionIndex]["current-container-index"];
        containerList = sectionsMap["sections"][currentSectionIndex]["containers"];
        nextContainerIndex = (currentContainerIndex + 1) % containerList.length;
        nextThumbnailIndex = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["current-thumbnail-index"];
        nextThumbnailId = sectionsMap["sections"][currentSectionIndex]["containers"][nextContainerIndex]["thumbnails"][nextThumbnailIndex]["thumbnail-id"];
        nextThumbnail = $("#" + nextThumbnailId);
        selectThumbnail(nextThumbnail);
    }
















// ---




    /*
    Collects data for Container Boxes and when it is done, it shows them in the Container
    
    Parameters
    sectionMap : A map where the thumbnail hierarchy is stored
    sectionIndex : The index of the HTML's thumbnail-section <div> (inside the thumbnal-sections <div>) where the new Container should go
    */
    class Container{
        constructor(title, sectionsMap, attributeMap, sectionIndex, section, containerIndex){
            //this.history = history;
            this.title = title;
            this.sectionsMap = sectionsMap;
            this.attributeMap = attributeMap;
            this.sectionIndex = sectionIndex;
            this.section = section;
            this.containerIndex = containerIndex
        }

        addNewContainerToSection(){
        
            // Add an empty thumbnail-container to the container list
//            var newLength = this.sectionsMap["sections"][this.sectionIndex]["containers"].push({});
//            var containerIndex = newLength - 1;

            // Create thumbnail-container object
            var thumbnailContainer = $('<div>', {
                class: this.attributeMap["container-class"],
                id: this.attributeMap["container-id"].format(this.sectionIndex, this.containerIndex)
            })
//            this.sectionsMap["sections"][this.sectionIndex]["containers"][this.containerIndex]["container-id"] = thumbnailContainer.attr('id');
            this.sectionsMap["sections"][this.sectionIndex]["containers"][this.containerIndex] = {};
            this.sectionsMap["sections"][this.sectionIndex]["containers"][this.containerIndex]["container-id"] = thumbnailContainer.attr('id')
            this.sectionsMap["sections"][this.sectionIndex]["containers"][this.containerIndex]["current-thumbnail-index"] = 0;
            this.sectionsMap["sections"][this.sectionIndex]["containers"][this.containerIndex]["thumbnails"] = [];

//            return {containerIndex: containerIndex, thumbnailContainer: thumbnailContainer}
            return {thumbnailContainer: thumbnailContainer}            
        }

        selectDefaultThumbnail(){
            var containers = this.sectionsMap["sections"][this.sectionIndex]["containers"];
            var defaultContainer = containers[defaultCurrentContainerIndex] 
            if(defaultContainer == undefined){
                var key = Object.keys(containers)[0];
                var defaultContainer = containers[key];
            }
            var defaultThumbnailContainerId = defaultContainer["container-id"];            
            var thumbnailClass = this.attributeMap["thumbnail-class"];
            var defaultThumbnails = $("#" + defaultThumbnailContainerId + " ." + thumbnailClass);
            var defaultThumbnail = defaultThumbnails.eq(defaultCurrentThumbnailIndex);

            // Turn off listeners

            selectThumbnail(defaultThumbnail);                                

            // Turn back listeners
        }

        static prepareNewOneSectionView(){
        
            var previousMap =  {
                "current-section-index": sectionsMap["current-section-index"],
                "sections": sectionsMap["sections"]
            }

            // Remove all elements from the <div id=thumbnail-sections> and <div id=detail-text-title> and <div id=detail-image-div>
            // sectionsMap["sections"] = []
            $("#thumbnail-sections").empty();
            $("#detail-text-title").empty();
            $("#detail-image-div").empty();
            sectionsMap["sections"] = [];

            // Create a new thumbnail-section
            var sectionLength = sectionsMap["sections"].push({});
            var sectionIndex0 = sectionLength - 1;
            sectionsMap["current-section-index"] = sectionIndex0;

            var thumbnailSection_0 = $('<div>', {
                id: attributeMap["section-id"].format(sectionIndex0),
                class: attributeMap["section-class"],
            })

            sectionsMap["sections"][sectionIndex0]["section-id"] = thumbnailSection_0.attr('id');
            sectionsMap["sections"][sectionIndex0]["containers"] = {};
            sectionsMap["sections"][sectionIndex0]["current-container-index"] = 0;

            // Place thumbnail-section into the thumbnail section
            $('#thumbnail-sections').append(thumbnailSection_0);

            return {"previous-map": previousMap, "section": thumbnailSection_0, "section-index": sectionIndex0}
        }

        showContainer(){
            throw new Error('You have to implement the method showContainer()!');
        }

        /*
        This method should be called if all data was collected to be able to show the container
        The boxess is a list of box
        The box is a dictionary with:
        "text", 
        "image", 
        "fn_focus", 
        "fn_select"
        */
        ready(boxes){

            // Add empty container to the container list and create and return thumbnail-container object
//            var ret = this.addNewContainerToSection(this.sectionsMap, this.sectionIndex);
            var ret = this.addNewContainerToSection();
//            var containerIndex = ret["containerIndex"];
            var thumbnailContainer = ret["thumbnailContainer"];

            for(var box in boxes){
                
                // card_id = record["id"];
                // source_path = record["source_path"];
                // title = record["title"];
                // title_orig = record["title_orig"];
                // lang_orig = record["lang_orig"];

                // Add an empty thumbnail to the thumbnail list
                var newLength = sectionsMap["sections"][this.sectionIndex]["containers"][this.containerIndex]['thumbnails'].push({});
                var thumbnailIndex = newLength - 1;
   
                // Create thumbnail
                var thumbnail = $("<div>", {
                    class: attributeMap["thumbnail-class"],
                    id: attributeMap["thumbnail-id"].format(this.sectionIndex, this.containerIndex, thumbnailIndex)
                });

                sectionsMap["sections"][this.sectionIndex]["containers"][this.containerIndex]["thumbnails"][thumbnailIndex]["thumbnail-id"] = thumbnail.attr('id');

                // Add Text to image
                var textWrapper = $("<div>", {
                    class: attributeMap["thumbnail-text-wrapper-class"],
                });
                thumbnail.append(textWrapper);  

                var text = $("<div>", {
                    class: attributeMap["thumbnail-text-class"],
                    text: boxes[box].getText(),
                });
                textWrapper.append(text);  

                // Create image
                var image = $("<img>",{
                    src: boxes[box].getImage(),
                    alt: "Image",
                });
                thumbnail.append(image);                 

                // CLICK/SELECT event for thumbnail
                // This special mechanism needed, otherwise the Function On Select always on the LATEST boxes[box] would be executed
                // thumbnail.click(function(){
                //     boxes[box].getFunctionOnSelect()();
                // });
                thumbnail.click((function(actualBox){
                    return function(event){
                        selectThumbnail($(event.currentTarget));
                        actualBox.getFunctionOnSelect()();
                    }
                })(boxes[box]));

                //FOCUS event for thumbnail
                // This special mechanism needed, otherwise the Function On Container Focus always on the LATEST boxes[box] would be executed
                // thumbnail.on("containerFocusEvent", function(event) {
                //     boxes[box].getFunctionOnFocus()();
                // });
                thumbnail.on("containerFocusEvent", (function(actualBox){
                    return function(event){
                        actualBox.getFunctionOnFocus()();
                    }
                })(boxes[box]));

                // Place thumbnail into thumbnail-container
                thumbnailContainer.append(thumbnail);
            }               

            // Append TITLE above the container
            var title = $("<div>",{
                class: "thumbnail-container-title",
                text: this.title
            });
            this.section.append(title);

            // Place thumbnail Container into thumbnail-section
            this.section.append(thumbnailContainer);

            // selection border for the default first thumbnail - it is possible as at least one section container is done
            this.selectDefaultThumbnail();            
        }
    }

    class AjaxContainer extends Container{
        constructor(title, sectionsMap, attributeMap, sectionIndex, section, containerIndex, type, url, async){
            super(title, sectionsMap, attributeMap, sectionIndex, section, containerIndex);

            this.type = type;
            this.url = url;
            this.async = async;

            this.showContainer();
        }

        showContainer(){
            var refToThis = this;

            /*
            Fetches the records
            */
            $.ajax({type: refToThis.type, url: refToThis.url, async: refToThis.async,
            success: function(result){

                var boxes = [];
                for (var i in result) {
                    var record=result[i];
                    var containerBox = refToThis.getContainerBox(record);
                    boxes.push(containerBox)
                }
                refToThis.ready(boxes);
            },
            error: function(xhr,status,error){
                $("#message").html("");
                $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
//              $("#spinner").hide();
            }            
        })}

        // Must return ContainerBox
        getContainerBox(record){
            throw new Error('You have to implement the method getContainerBox(record)!');
        }

        showBigPicture(id, src, title, title_orig, lang_orig){
       
            // For an unknown reason only this solution works
            // if I run the below command, it will not resize the image
            // $('#detail-image-div').css("background", "url(" + src + ")  no-repeat 0 0");
            t.style.setProperty('--background-image', "url(" + src + ")");

            if(title){
                $('#detail-text-title').text(title);
            }else{
                $('#detail-text-title').text(title_orig);            
            }
        }
    }

    /*
    Collects records through the get_standalone_movies_by_genre() method
    Typically used:
        -From the main menu where we tell that we want menu of movies
    the id of the record points to Card table if the level field IS null
    The record has the following fields:
        "id"
        "source_path"
        "title_req"
        "title_orig"
        "lang_orig"
    */
    class AjaxCardContainer extends AjaxContainer{
        getContainerBox(record){
            var refToThis = this;

            var source_path = record["source_path"];
            var title = "";
            var title_orig = "";
            var lang_orig = "";
            var card_id = record["id"];
            if ( record["title_req"] != null ){
                title = record["title_req"];
            }
            if ( record["title_orig"] != null ){
                title_orig = record["title_orig"];
                lang_orig = record["lang_orig"];
            }
                
            var container = new ContainerBox(
                "",
                source_path + '/image.jpg',
                  
                // In focus
                (function(card_id, source, title, title_orig, lang_orig) {
                    return function() {
                        refToThis.showBigPicture(card_id, source, title, title_orig, lang_orig);
                    };
                })(card_id, source_path + '/image.jpg', title, title_orig, lang_orig),
                        
                // Select
                (function(card_id, source, title, title_orig, lang_orig) {
                    return function() {
//                               selectThumbnail(nextThumbnail)
/*                               refToThis.showBigPicture(card_id, source, title, title_orig, lang_orig);*/
                    };
                })(card_id, source_path + '/image.jpg', title, title_orig, lang_orig),
            );
            return container;
        }
    }

    /*
    Collects records through the get_all_series_of_movies() method
    Typically used:
        -From the main menu where we tell that we want menu of movie series
    the id of the record points to Card table if the level field IS null
    The record has the following fields:
        "id"
        "source_path"
        "title_req"
        "title_orig"
        "lang_orig"
    */
    class AjaxHierarchyContainer extends AjaxContainer{

        getContainerBox(record){
            var refToThis = this;

            var id = record["id"];
            var source_path = record["source_path"];
                    
            var box_title = "";
            var box_title_orig = "";
            var lang_orig = "";
            if ( record["title_req"] != null ){
                box_title = record["title_req"];
            }
            if ( record["title_orig"] != null ){
                box_title_orig = record["title_orig"];
                lang_orig = record["lang_orig"];
            }
                
            var container = new ContainerBox(
                "",                             /*series title on thumbnail, not necessary*/
                source_path + '/image.jpg',
                     
                // In focus
                (function(id, source, title, title_orig, lang_orig) {
                    return function() {
                        refToThis.showBigPicture(id, source, title, title_orig, lang_orig);
                    };
                })(id, source_path + '/image.jpg', box_title, box_title_orig, lang_orig),
                        
                // Select
                (function(id, title) {
                    return function() {
                        refToThis.openChildHierarchyOrCardMenu(id, title);
                    };
                })(id, box_title),
            );
            return container;
        }           

        // Selected
        openChildHierarchyOrCardMenu(id, title){
            
            var ret = Container.prepareNewOneSectionView();
            var sectionIndex = ret["section-index"];
            var section = ret["section"];
            var containerIndex = "0";

            container = new AjaxChildHierarchyOrCardContainer(
                title,
                sectionsMap,
                attributeMap, 
                sectionIndex,
                section,
                containerIndex,
                "GET",
                "/collect/child_hierarchy_or_card/id/" + id + "/lang/" + languageCode,
                true                
            );


//--


var dramaContainer = new AjaxCardContainer(
                "Drama",
                sectionsMap,
                attributeMap, 
                sectionIndex,
                section,
                "1",
                "GET",
                "/collect/standalone/movies/genre/drama/lang/" + languageCode,
                true
            );

//--            
            containerHistory.add(title, [container,dramaContainer]);
            containerHistory.showLink()
        }
    }

    /*
    Collects records through the get_child_hierarchy_or_card() method
    Typically used:
        -from the AjaxHierarchyContainer class as the selected element can be Card or Hierarchy as well
        -from the AjaxChildHierarchyOrCardContainer (here) as the selected element can be Card or Hierarchy as well
    The id of the record points to Hierarchy table if the level field is NOT null
    the id of the record points to Card table if the level field IS null
    The record has the following fields:
        "id"
        "level"
        "sequence"
        "source_path"
        "title_req"
        "title_orig"
        "lang_orig"
    */
    class AjaxChildHierarchyOrCardContainer extends AjaxContainer{
        getContainerBox(record){
            var refToThis = this;

            var id = record["id"];
            var level = record["level"];
            var sequence = record["sequence"];
            var source_path = record["source_path"];
                    
            var box_title = "";
            var box_title_orig = "";
            var lang_orig = "";
            if ( record["title_req"] != null ){
                box_title = record["title_req"];
            }
            if ( record["title_orig"] != null ){
                box_title_orig = record["title_orig"];
                lang_orig = record["lang_orig"];
            }
                                    
            container = new ContainerBox(
                level==null?sequence: box_title,   // if no level, than it is an episode
                source_path + '/image.jpg',
                        
                // Focus
                (function(id, source, title, title_orig, lang_orig) {
                    return function() {
                        refToThis.showBigPicture(id, source, title, title_orig, lang_orig);
                    };
// TODO: must fix the title: add to the right language
                })(id, source_path + '/image.jpg', refToThis.title + "-" + box_title, refToThis.title + "-" + box_title_orig, lang_orig),
                   
                // Select
                (function(id, level, title) {
                    return function() {
console.log(id + " - " + level + " - " + refToThis.title + " - " + title);
                        if(level != null){
                            refToThis.openChildHierarchyOrCardMenu(id, level, refToThis.title + "-" + title)
                        }
                    };
                })(id, level, box_title),
            );
            return container;
        }

        // Go deeper
        openChildHierarchyOrCardMenu(id, level, title){
            
            var ret = Container.prepareNewOneSectionView();
            var sectionIndex = ret["section-index"];
            var section = ret["section"];
            var containerIndex = "0";

            container = new AjaxChildHierarchyOrCardContainer(
                title,
                sectionsMap,
                attributeMap, 
                sectionIndex,
                section,
                containerIndex,
                "GET",
                "/collect/child_hierarchy_or_card/id/" + id + "/lang/" + languageCode,
                true,
            );
            containerHistory.add(title, [container]);
            containerHistory.showLink()
        }
    }

    class MenuContainer extends Container{

        constructor(title, sectionsMap, attributeMap, sectionIndex, section, containerIndex){
            super(title, sectionsMap, attributeMap, sectionIndex, section, containerIndex);

            this.showContainer();
        }

        showContainer(){
            var refToThis = this;

            /*
            The records is a list of records
            And all recordss should have:
            "text"
            "image"
            */
            var boxes = [];
            var records = refToThis.getRecords();
            for (var i=0; i < records.length; i++) {
        
                var record = records[i];

                // boxes.push(new ContainerBox(
                //     record["text"],
                //     record["image"],
               
                //     (function(par) {
                //         return function() {
                //             //refToThis.openDetails(par);
                //         };
                //     })(1),

                //     (function(fn_submenu) {
                //         return function() {
                //             fn_submenu();
                //         };
                //     })(record["fn_submenu"])
                // ))

                boxes.push(refToThis.getContainerBox(record));
            }          
            this.ready(boxes);
        }   

        getContainerBox(record){
            var container = new ContainerBox(
                    record["text"],
                    record["image"],
               
                    (function(par) {
                        return function() {
                            //refToThis.openDetails(par);
                        };
                    })(1),

                    (function(fn_submenu) {
                        return function() {
                            fn_submenu();
                        };
                    })(record["fn_submenu"])
            )
            return container;
        }

        getRecords(){
            throw new Error('You have to implement the method getRecords()!');
        }

        openDetails(id, src, title, title_orig, lang_orig){

            // For an unknown reason only this solution works
            // if I run the below command, it will not resize the image
            // $('#detail-image-div').css("background", "url(" + src + ")  no-repeat 0 0");
            t.style.setProperty('--background-image', "url(" + src + ")");

            if(title){
                $('#detail-text-title').text(title);
            }else{
                $('#detail-text-title').text(title_orig);            
            }
        }
    }

    class ContainerBox{
        constructor(text, image, fn_focus, fn_select){
            this.text = text;
            this.image = image;
            this.fn_focus = fn_focus;
            this.fn_select = fn_select;
        }

        getText(){
            return this.text;
        }

        getImage(){
            return this.image;
        }

        getFunctionOnFocus(){
            return this.fn_focus;
        }

        getFunctionOnSelect(){
            return this.fn_select;
        }
    }

    class History{
        constructor(historyContainer){
            this.historyContainer = historyContainer;
            this.index = -1;
            this.history = [];
        }

        add(title, containerList){
            this.index++;
            this.history.push({"index": this.index, "title": title, "container-list": containerList});
        }

        showLink(){
            var refToThis = this;

            // remove child elements
            this.historyContainer.empty();

            for (var i=0; i < this.history.length-1; i++) {
                var title = this.history[i]["title"];

                var link = $('<div class="link">');
                // This special mechanism needed, otherwise the Function On Select always on the LATEST boxes[box] would be executed
                // thumbnail.click(function(){
                //     boxes[box].getFunctionOnSelect()();
                // });
                link.click((function(index){
                    return function(event){
                        refToThis.backInHistory(index)
                    }
                })(i));

                link.text(title);
                if(i>0)
                    this.historyContainer.append(" > ");
                this.historyContainer.append(link);
            }
        }


        backInHistory(index){

            var containerList = this.history[index]["container-list"]

            this.history.length = index+1;
            this.showLink();

            for(var i=0; i<containerList.length; i++){
                console.log(containerList[i].sectionsMap['sections'][0]['containers'][0]['current-thumbnail-index']);
            }

            var ret = Container.prepareNewOneSectionView();
            var sectionIndex = ret["section-index"];
            var section = ret["section"];

            for(var i=0; i<containerList.length; i++){
                containerList[i].sectionIndex = sectionIndex;
                containerList[i].section = section
                containerList[i].sectionsMap = sectionsMap;
                containerList[i].showContainer();
            }
        }
    }

    // TODO: add it to the the menu
    let containerHistory;


// ---








    class MainMenuLevel extends MenuContainer{
        constructor(sectionsMap, attributeMap, containerIndex){
            var ret = Container.prepareNewOneSectionView();
            var title = "Categories";
            var sectionIndex = ret["section-index"];
            var section = ret["section"];
//            var mainMenuContainer = new MenuContainer(title, sectionsMap, attributeMap, sectionIndex, section, records)
            super(title, sectionsMap, attributeMap, sectionIndex, section, containerIndex);
            
            containerHistory.add(title, [this]);
            containerHistory.showLink()

        }

        getRecords(){
            var refToThis = this;
            var records = [
                {text: "Movies", image: "images/categories/movie.jpg", fn_submenu: function(){refToThis.viewMovie()}},
                {text: "Movie Series", image: "images/categories/series.jpg", fn_submenu: function(){refToThis.viewMovieSeries()}},
                {text: "Music Video", image: "images/categories/music_video.jpg", fn_submenu: function(){}},
                {text: "Music Audio", image: "images/categories/music_audio.jpg", fn_submenu: function(){}},
            ]
            return records;
        }

        /*
        Shows the Movie selection View
        */
        viewMovie(){
        
            var ret = Container.prepareNewOneSectionView();
            var sectionIndex = ret["section-index"];
            var section = ret["section"];
            var dramaContainerIndex = "0";
            var actionContainerIndex = "1";

            var dramaContainer = new AjaxCardContainer(
                "Drama",
                sectionsMap,
                attributeMap, 
                sectionIndex,
                section,
                dramaContainerIndex,
                "GET",
                "/collect/standalone/movies/genre/drama/lang/" + languageCode,
                true
            );

            var actionContainer = new AjaxCardContainer(
                "Action",
                sectionsMap,
                attributeMap, 
                sectionIndex,
                section,
                actionContainerIndex,
                "GET",
                "/collect/standalone/movies/genre/action/lang/" + languageCode,
                true
            );

            containerHistory.add("Movie", [dramaContainer, actionContainer]);
            containerHistory.showLink()
        }

        /*
        Shows the Movie Series selection View
        */
        viewMovieSeries(){
        
            var ret = Container.prepareNewOneSectionView();
            var sectionIndex = ret["section-index"];
            var section = ret["section"];
            var seriesContainerIndex = "0";

            var seriesContainer = new AjaxHierarchyContainer(
                "Series",
                sectionsMap,
                attributeMap, 
                sectionIndex,
                section,
                seriesContainerIndex,
                "GET",
                "/collect/all/series/movies/lang/" + languageCode,
                true
            );

            containerHistory.add("Series", [seriesContainer]);
            containerHistory.showLink()
        } 
    }
    


    






    var defaultCurrentSectionIndex = 0;
    var defaultCurrentContainerIndex = "0";
    var defaultCurrentThumbnailIndex = 0;

    var languageCode = 'hu';

    // ================================================
    // ================================================
    //
    //  When the page is loaded
    //
    // ================================================
    // ================================================
    $(document).ready(function(){

        // TODO: add it to the the menu
        containerHistory = new History($('#history-container'));

        mainContainer = new MainMenuLevel(sectionsMap, attributeMap, "0")
    })

    </script>

</head>
<body style="background-color:DarkGrey;">

    <div id="detail-screen">
        <div id="detail-text-div">
            <div id="detail-text-title"></div>
        </div>
        <div id="detail-image-div">
<!--            <img id="detail-image"> -->
        </div>

    </div>


    <div id="history-container"></div>
    <div id="thumbnail-sections" tabindex="0">
    </div>

    <div id="message"></div>
    <div id="errormessage"></div>
    
</body>
</html>